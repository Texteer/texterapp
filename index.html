<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Chat</title>
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; background:#0a0f1a; color:#fff; display:flex; height:100vh; }
header { background:#0f1524; padding:1rem; text-align:center; font-size:1.5rem; font-weight:bold; position:fixed; top:0; left:0; width:100%; z-index:5; display:flex; justify-content:space-between; align-items:center; }
#toggleSidebar { background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer; display:none; }
#chatContainer { flex:1; display:flex; flex-direction:column; margin-top:60px; }
#messages { flex:1; padding:1rem; overflow-y:auto; display:flex; flex-direction:column; gap:0.3rem; }
.message { padding:0.6rem 1rem; border-radius:15px; max-width:65%; word-break:break-word; display:flex; align-items:center; }
.message.self { background:#0b78e3; align-self:flex-end; color:#fff; flex-direction:row-reverse; }
.message.other { background:#1c2335; align-self:flex-start; color:#fff; }
.timestamp { font-size:0.65rem; color:#7a7a7a; margin-left:0.5rem; margin-right:0.5rem; }
#input { display:flex; padding:0.5rem; background:#101426; border-top:1px solid #1c2335; }
#input input { flex:1; padding:0.6rem 1rem; border-radius:20px 0 0 20px; border:none; background:#141a2c; color:#fff; }
#input button { padding:0.6rem 1.2rem; border:none; border-radius:0 20px 20px 0; background:#0b78e3; color:#fff; cursor:pointer; font-weight:bold; }
#authModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:10; }
#authBox { background:#101426; padding:2rem; border-radius:15px; width:320px; display:flex; flex-direction:column; box-shadow:0 5px 20px rgba(0,0,0,0.5); }
#authBox input { margin-bottom:1rem; padding:0.6rem; border-radius:8px; border:none; background:#141a2c; color:#fff; }
#authBox button { padding:0.6rem; border:none; border-radius:8px; background:#0b78e3; color:#fff; font-weight:bold; cursor:pointer; }
#typingIndicator { font-size:0.85rem; color:#7a7a7a; padding-left:1rem; margin-bottom:0.2rem; height:18px; }
#sidebar { width:220px; background:#0f1524; padding:1rem; border-left:1px solid #1c2335; display:flex; flex-direction:column; transition:transform 0.3s ease; }
#sidebar h3 { margin:0 0 1rem 0; font-size:1.1rem; border-bottom:1px solid #1c2335; padding-bottom:0.5rem; }
#userList { display:flex; flex-direction:column; gap:0.5rem; }
.userItem { display:flex; align-items:center; gap:0.5rem; }

/* Mobile collapsible sidebar */
@media (max-width: 768px) {
  #sidebar { position:fixed; top:60px; right:0; height:100%; transform:translateX(100%); z-index:9; }
  #sidebar.active { transform:translateX(0); }
  #toggleSidebar { display:block; }
}
</style>
</head>
<body>

<header>
  Global Chat
  <button id="toggleSidebar">â˜°</button>
</header>

<div id="chatContainer">
  <div id="typingIndicator"></div>
  <div id="messages"></div>
  <div id="input">
    <input type="text" id="messageInput" placeholder="Type your message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<div id="sidebar">
  <h3>Online Users</h3>
  <div id="userList"></div>
</div>

<div id="authModal">
  <div id="authBox">
    <h2>Enter Code</h2>
    <input type="text" id="codeInput" placeholder="Enter your code">
    <button id="loginBtn">Enter Chat</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const supabaseUrl = 'https://azpgwbxillscpwrraprl.supabase.co';
  const supabaseKey = 'YOUR_ANON_KEY'; // Replace with your anon key
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = null;
  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const codeInput = document.getElementById('codeInput');
  const loginBtn = document.getElementById('loginBtn');
  const authModal = document.getElementById('authModal');
  const toggleSidebar = document.getElementById('toggleSidebar');
  const sidebar = document.getElementById('sidebar');

  // Sidebar toggle
  toggleSidebar.onclick = () => {
    sidebar.classList.toggle('active');
  };

  // Helpers
  function getInitials(name) {
    return name.split(' ').map(n => n[0].toUpperCase()).join('').slice(0,2);
  }
  function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    return `hsl(${hash % 360}, 70%, 50%)`;
  }
  function createProfileCircle(username) {
    const span = document.createElement('span');
    span.style.cssText = `
      display:inline-flex; justify-content:center; align-items:center;
      width:30px; height:30px; border-radius:50%;
      background:${stringToColor(username)}; color:#fff; font-weight:bold; font-size:0.8rem;
    `;
    span.textContent = getInitials(username);
    return span;
  }

  // Login
  async function loginWithCode(code) {
    const parsedCode = isNaN(code) ? code : parseInt(code); // support both text and int
    const { data, error } = await supabaseClient
      .from('chat_codes')
      .select('username')
      .eq('code', parsedCode)
      .single();

    if (error || !data) {
      alert('Invalid code');
      return;
    }

    currentUser = { username: data.username, code: parsedCode };
    localStorage.setItem('chatCode', parsedCode);
    authModal.style.display = 'none';
  }

  loginBtn.onclick = () => {
    const code = codeInput.value.trim();
    if (!code) return alert('Enter your code');
    loginWithCode(code);
  };

  const savedCode = localStorage.getItem('chatCode');
  if (savedCode) loginWithCode(savedCode);
});
</script>
</body>
</html>
