<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Texter â€” Global & DMs (Improved)</title>
<style>
:root{
  --bg:#0b1020; --panel:#121a2b; --panel-2:#0f172a; --accent:#3b82f6; --text:#e5e7eb;
  --muted:#8aa0c6; --border:#1f2a44; --me:#2563eb; --them:#1f2937; --danger:#ef4444; --success:#22c55e;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:linear-gradient(140deg,#000,#0b1a33 45%,#000); color:var(--text);}
body{display:flex; justify-content:center; align-items:center; min-height:100vh;}
.app{width:100%; max-width:1100px; height:92vh; display:grid; gap:10px; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr auto; grid-template-areas:"header header" "sidebar chat" "sidebar input"; background:var(--bg); border:1px solid var(--border); border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.4);}
header{grid-area:header; background:var(--panel); padding:14px 18px; display:flex; justify-content:space-between; border-bottom:1px solid var(--border);}
.brand{color:var(--accent); font-weight:700}
.meInfo{color:var(--muted)}
.sidebar{grid-area:sidebar; background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column}
.sidebar-top{display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--border); align-items:center}
.sidebar-top .btn{flex:1}
.results, .friends{overflow:auto; padding-bottom:8px}
.search input{width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:#071228; color:var(--text)}
.list-item{display:flex; gap:10px; align-items:center; padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.03)}
.list-item:hover{background:#0e1730}
.avatar{width:36px; height:36px; border-radius:50%; display:grid; place-items:center; font-weight:700; color:#cde1ff; background:#0e2a5a; border:1px solid #18325e}
.meta .name{font-size:.95rem}
.meta .muted{color:var(--muted); font-size:.82rem}
.badge{background:var(--danger); color:white; border-radius:999px; padding:2px 8px; font-size:12px}

/* Chat */
.chat{grid-area:chat; display:flex; flex-direction:column; background:var(--panel-2);}
.chat-header{padding:12px 16px; border-bottom:1px solid var(--border); display:flex; gap:10px; align-items:center}
.messages{flex:1; overflow-y:auto; padding:14px; display:flex; flex-direction:column; gap:10px;}
.bubble{max-width:78%; padding:10px 12px; border-radius:12px; line-height:1.3; word-wrap:break-word}
.bubble.me{align-self:flex-end; background:var(--me); color:white}
.bubble.them{align-self:flex-start; background:var(--them); color:#e6eefc}
.bubble .from{display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:.82rem; color:#cdd8ff}

/* Typing indicator */
.typing-indicator{font-size:.85rem; color:var(--accent); padding:0 16px; min-height:20px;}

/* Composer */
.composer{grid-area:input; display:flex; gap:10px; padding:12px; background:var(--panel); border-top:1px solid var(--border)}
.composer input{flex:1; padding:12px; border-radius:10px; border:1px solid var(--border); background:#071228; color:var(--text)}
.btn{padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0c1426; color:var(--text); cursor:pointer}
.btn.primary{background:var(--accent); border-color:transparent}

/* Small screens */
@media (max-width:900px){ .app{grid-template-columns:1fr; grid-template-areas:"header" "chat" "input"} .sidebar{display:none} .send-mobile{display:inline-flex} }
</style>
</head>
<body>

<div id="appRoot" class="app">
  <header>
    <div class="brand">Texter</div>
    <div class="meInfo" id="meInfo">â€”</div>
  </header>

  <aside class="sidebar">
    <div class="sidebar-top">
      <button id="toggleAdd" class="btn">âž• Add</button>
      <button id="toggleReq" class="btn">ðŸ”” Requests <span id="reqCount" class="badge" style="display:none;margin-left:6px">0</span></button>
      <button id="logoutBtn" class="btn" style="margin-left:auto">Sign out</button>
    </div>
    <div style="padding:10px;border-bottom:1px solid var(--border)">
      <div class="search"><input id="searchBox" placeholder="Search usernameâ€¦" /></div>
    </div>
    <div class="friends" id="friendsList"></div>
  </aside>

  <section class="chat">
    <div class="chat-header">
      <div class="avatar" id="roomAvatar">GC</div>
      <div class="chat-title" id="roomTitle">Global Chat</div>
    </div>
    <div class="typing-indicator" id="typingIndicator"></div>
    <div class="messages" id="messages"></div>
  </section>

  <div class="composer">
    <input id="composerInput" placeholder="Type a messageâ€¦ (Enter to send)" />
    <button id="sendMobileBtn" class="btn primary send-mobile">Send</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON = "YOUR_SUPABASE_ANON";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = id => document.getElementById(id);

let me = {email:"user@example.com", username:"User"}; // demo
let currentView = {type:'global', peerEmail:null};
let messagesDedup = new Set();
let typingUsers = new Set();

// =====================
// Helper: Scroll messages
function scrollChat(){$('messages').scrollTop = $('messages').scrollHeight;}

// =====================
// Add message
function addMessage(msg){
  const key = msg.sender_email + '::' + (msg.message||'') + '::' + (msg.created_at||Date.now());
  if(messagesDedup.has(key)) return;
  messagesDedup.add(key);
  const div = document.createElement('div');
  div.className = 'bubble ' + (msg.sender_email===me.email?'me':'them');
  if(msg.sender_email!==me.email){
    div.innerHTML = `<div class="from"><div class="avatar" style="width:26px;height:26px;font-size:.8rem">${msg.username[0]}</div><div>${msg.username}</div></div><div>${msg.message}</div>`;
  }else{
    div.innerHTML = `<div>${msg.message}</div>`;
  }
  $('messages').appendChild(div);
  scrollChat();
}

// =====================
// Typing indicator update
function updateTypingIndicator(){
  const arr = Array.from(typingUsers);
  if(arr.length===0) $('typingIndicator').innerText='';
  else if(arr.length===1) $('typingIndicator').innerText=arr[0]+' is typing...';
  else $('typingIndicator').innerText=arr.join(' and ')+' are typing...';
}

// =====================
// Send message
async function sendMessage(){
  const txt = $('composerInput').value.trim();
  if(!txt) return;
  // insert into supabase messages table
  const payload = { username: me.username, message: txt, sender_email: me.email };
  const { data, error } = await sb.from('messages').insert([payload]).select();
  if(error) { console.error(error); return; }
  if(data && data[0]) addMessage(data[0]);
  $('composerInput').value='';
  // broadcast stop typing
  sb.channel('public:messages').send({type:'typing', event:'stop', username:me.username});
}

// =====================
// Composer event
$('composerInput').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }
  else sb.channel('public:messages').send({type:'typing', event:'start', username:me.username});
});
$('composerInput').addEventListener('keyup', e=>{
  setTimeout(()=>sb.channel('public:messages').send({type:'typing', event:'stop', username:me.username}), 2000);
});

// =====================
// Subscribe global messages + typing
const globalChannel = sb.channel('public:messages')
  .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, payload=>{
    const m = payload.new;
    if(m.sender_email!==me.email) addMessage(m);
  })
  .on('broadcast', { event:'typing' }, payload=>{
    if(payload.event==='start') typingUsers.add(payload.username);
    else typingUsers.delete(payload.username);
    updateTypingIndicator();
  })
  .subscribe();
</script>
</body>
</html>
