<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Realtime Chat with DMs</title>
  <style>
    body { margin:0; font-family: 'Segoe UI', sans-serif; background:#0a0a0a; color:#fff; display:flex; height:100vh; }
    #sidebar { width:250px; background:#111; border-right:1px solid #333; overflow-y:auto; padding:10px; }
    #chat { flex:1; display:flex; flex-direction:column; }
    #header { background:#111; padding:10px; border-bottom:1px solid #333; font-weight:bold; }
    #messages { flex:1; overflow-y:auto; padding:10px; }
    #input { display:flex; border-top:1px solid #333; }
    #input input { flex:1; padding:10px; border:none; outline:none; background:#222; color:#fff; }
    #input button { background:#007bff; border:none; color:#fff; padding:10px 20px; cursor:pointer; }
    .message { margin-bottom:10px; display:flex; align-items:center; }
    .message.self { justify-content:flex-end; }
    .bubble { padding:10px; border-radius:10px; max-width:60%; }
    .self .bubble { background:#007bff; }
    .other .bubble { background:#333; }
    .userItem { display:flex; align-items:center; margin-bottom:8px; cursor:pointer; padding:5px; border-radius:6px; }
    .userItem:hover { background:#222; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Users</h3>
    <div id="userList"></div>
  </div>
  <div id="chat">
    <div id="header">Global Chat</div>
    <div id="messages"></div>
    <div id="input">
      <input id="messageInput" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://azpgwbxillscpwrraprl.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cGd3YnhpbGxzY3B3cnJhcHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg1MjQsImV4cCI6MjA3MjYzNDUyNH0.h7ZDxtH4pB3K5IzRB9goLJ1ldrY6EGf7CWT-ELGQ0i0";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const userListEl = document.getElementById("userList");
    const messagesEl = document.getElementById("messages");
    const headerEl = document.getElementById("header");
    const messageInput = document.getElementById("messageInput");

    let currentUser = { username: prompt("Enter your username") };
    let currentChat = { type: "global", target: null };

    // Save user to users table if not exists
    async function registerUser() {
      await supabaseClient.from("users").upsert({ username: currentUser.username });
      await supabaseClient.from("online_users").upsert({ username: currentUser.username, last_seen: new Date().toISOString() });
    }
    registerUser();

    // Create profile circle with unique color
    function stringToColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      return `hsl(${hash % 360}, 70%, 50%)`;
    }
    function getInitials(name) {
      return name.split(" ").map(n => n[0].toUpperCase()).join("");
    }
    function createProfileCircle(username) {
      const span = document.createElement("span");
      span.style.cssText = `
        display:inline-flex;justify-content:center;align-items:center;
        width:24px;height:24px;border-radius:50%;background:${stringToColor(username)};
        color:#fff;font-weight:bold;font-size:0.7rem;margin-right:5px;
      `;
      span.textContent = getInitials(username);
      return span;
    }

    // Load all users with online/offline status
    async function loadUsers() {
      const { data: allUsers } = await supabaseClient.from("users").select("username");
      const { data: online } = await supabaseClient.from("online_users").select("username");
      const onlineSet = new Set(online.map(u => u.username));

      userListEl.innerHTML = "";
      allUsers.forEach(u => {
        const item = document.createElement("div");
        item.className = "userItem";
        const circle = createProfileCircle(u.username);

        const dot = document.createElement("span");
        dot.style.cssText = `
          width:10px;height:10px;border-radius:50%;margin-left:5px;
          background:${onlineSet.has(u.username) ? "#0f0" : "#555"};
          display:inline-block;
        `;

        const nameEl = document.createElement("span");
        nameEl.textContent = u.username;

        item.appendChild(circle);
        item.appendChild(nameEl);
        item.appendChild(dot);

        item.onclick = () => openPrivateChat(u.username);

        userListEl.appendChild(item);
      });
    }

    // Load global messages
    async function loadGlobalMessages() {
      const { data } = await supabaseClient.from("global_messages").select("*").order("created_at", { ascending: true });
      data.forEach(m => {
        appendMessage(m, m.username === currentUser.username ? "self" : "other");
      });
    }

    // Append a message
    function appendMessage(msg, type) {
      const div = document.createElement("div");
      div.className = "message " + type;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = `${msg.username}: ${msg.message}`;
      div.appendChild(bubble);
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Open private chat
    async function openPrivateChat(username) {
      if (username === currentUser.username) return;
      currentChat = { type: "private", target: username };
      headerEl.textContent = `Chat with ${username}`;
      messagesEl.innerHTML = "";

      const { data } = await supabaseClient
        .from("private_messages")
        .select("*")
        .or(`and(sender.eq.${currentUser.username},receiver.eq.${username}),and(sender.eq.${username},receiver.eq.${currentUser.username})`)
        .order("created_at", { ascending: true });

      data.forEach(m => {
        appendMessage(m, m.sender === currentUser.username ? "self" : "other");
      });

      subscribePrivate(username);
    }

    // Send message
    async function sendMessage() {
      if (!messageInput.value) return;
      const content = messageInput.value;
      messageInput.value = "";

      if (currentChat.type === "global") {
        const newMessage = { username: currentUser.username, message: content, created_at: new Date().toISOString() };
        appendMessage(newMessage, "self");
        await supabaseClient.from("global_messages").insert([newMessage]);
      } else {
        const newMessage = { sender: currentUser.username, receiver: currentChat.target, message: content, created_at: new Date().toISOString() };
        appendMessage(newMessage, "self");
        await supabaseClient.from("private_messages").insert([newMessage]);
      }
    }

    // Realtime subscriptions
    function subscribeGlobal() {
      supabaseClient.channel("global")
        .on("postgres_changes", { event: "INSERT", schema: "public", table: "global_messages" }, payload => {
          const m = payload.new;
          if (m.username !== currentUser.username) {
            appendMessage(m, "other");
          }
        })
        .subscribe();
    }

    function subscribePrivate(username) {
      supabaseClient.channel(`private-${username}-${currentUser.username}`)
        .on("postgres_changes", { event: "INSERT", schema: "public", table: "private_messages" }, payload => {
          const m = payload.new;
          if (
            (m.sender === username && m.receiver === currentUser.username) ||
            (m.receiver === username && m.sender === currentUser.username)
          ) {
            if (m.sender !== currentUser.username) {
              appendMessage(m, "other");
            }
          }
        })
        .subscribe();
    }

    // Init
    loadUsers();
    loadGlobalMessages();
    subscribeGlobal();
    setInterval(loadUsers, 5000); // refresh user list
  </script>
</body>
</html>
