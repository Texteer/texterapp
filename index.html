<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dark Chat App</title>
<style>
body { margin:0; font-family:sans-serif; background:#0b0f1a; color:#fff; }
header { background:#101426; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
button { cursor:pointer; border:none; border-radius:4px; padding:0.5rem 1rem; }
main { display:flex; height:90vh; }
#friends { width:250px; background:#141a2c; padding:1rem; overflow-y:auto; }
#chat { flex:1; display:flex; flex-direction:column; background:#0d1326; }
#messages { flex:1; padding:1rem; overflow-y:auto; }
#input { display:flex; padding:0.5rem; background:#101426; }
#input input { flex:1; padding:0.5rem; border:none; border-radius:4px 0 0 4px; }
#input button { background:#0b78e3; color:#fff; border-radius:0 4px 4px 0; }
.message { margin-bottom:0.5rem; }
.message.self { text-align:right; color:#0b78e3; }
.friend { padding:0.5rem; border-bottom:1px solid #1c2335; cursor:pointer; }
.friend:hover { background:#1c2335; }
#typingIndicator { font-size:0.9rem; color:#7a7a7a; margin-bottom:0.5rem; }
</style>
</head>
<body>

<header>
  <div>Dark Chat</div>
  <div id="auth-buttons">
    <button id="signup-btn">Sign Up</button>
    <button id="login-btn">Login</button>
    <button id="logout-btn" style="display:none;">Logout</button>
  </div>
</header>

<main>
  <div id="friends"></div>
  <div id="chat">
    <div id="typingIndicator"></div>
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://azpgwbxillscpwrraprl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cGd3YnhpbGxzY3B3cnJhcHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg1MjQsImV4cCI6MjA3MjYzNDUyNH0.h7ZDxtH4pB3K5IzRB9goLJ1ldrY6EGf7CWT-ELGQ0i0';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;
let activeChat = null;
let chatType = 'public'; // 'public' or 'private'

// ----------------- AUTH -----------------
async function signUp() {
  const email = prompt("Email?");
  const password = prompt("Password?");
  const username = prompt("Username?");
  const { data, error } = await supabase.auth.signUp({ email, password });
  if (error) return alert(error.message);
  await supabase.from('users').insert([{ id: data.user.id, username }]);
  alert("Signed up! Please login.");
}

async function login() {
  const email = prompt("Email?");
  const password = prompt("Password?");
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);
  currentUser = data.user;
  document.getElementById('auth-buttons').style.display = 'none';
  document.getElementById('logout-btn').style.display = 'inline';
  loadFriends();
  loadMessages();
  subscribeMessages();
  subscribeTyping();
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

document.getElementById('signup-btn').onclick = signUp;
document.getElementById('login-btn').onclick = login;
document.getElementById('logout-btn').onclick = logout;

// ----------------- FRIENDS -----------------
async function loadFriends() {
  const { data: friendsData } = await supabase.from('friends').select('user_id, friend_id, status, users!inner(username)').or(`user_id.eq.${currentUser.id},friend_id.eq.${currentUser.id}`);
  const friendsDiv = document.getElementById('friends');
  friendsDiv.innerHTML = '';
  friendsData.forEach(f => {
    const friendId = f.user_id === currentUser.id ? f.friend_id : f.user_id;
    const div = document.createElement('div');
    div.textContent = f.users.username;
    div.className = 'friend';
    div.onclick = () => openChat(friendId);
    friendsDiv.appendChild(div);
  });
}

// ----------------- MESSAGES -----------------
async function loadMessages() {
  if(chatType === 'public') {
    const { data: msgs } = await supabase.from('public_messages').select('*').order('created_at', { ascending:true });
    document.getElementById('messages').innerHTML = '';
    msgs.forEach(displayMessage);
  } else if(activeChat) {
    const { data: msgs } = await supabase.from('messages').select('*').or(`(sender_id.eq.${currentUser.id},receiver_id.eq.${activeChat}),(sender_id.eq.${activeChat},receiver_id.eq.${currentUser.id})`).order('created_at', { ascending:true });
    document.getElementById('messages').innerHTML = '';
    msgs.forEach(displayMessage);
  }
}

function displayMessage(msg) {
  const div = document.createElement('div');
  div.className = 'message ' + (msg.sender_id === currentUser.id ? 'self' : '');
  div.textContent = msg.message;
  document.getElementById('messages').appendChild(div);
  div.scrollIntoView();
}

document.getElementById('sendBtn').onclick = async () => {
  const input = document.getElementById('messageInput');
  if(!input.value) return;
  if(chatType === 'public') {
    await supabase.from('public_messages').insert([{ sender_id: currentUser.id, message: input.value }]);
  } else if(activeChat) {
    await supabase.from('messages').insert([{ sender_id: currentUser.id, receiver_id: activeChat, message: input.value }]);
  }
  input.value = '';
  setTyping(false);
}

// ----------------- CHAT SELECTION -----------------
function openChat(friendId) {
  activeChat = friendId;
  chatType = 'private';
  loadMessages();
}

// ----------------- REALTIME -----------------
function subscribeMessages() {
  // Private messages
  supabase.channel('private_messages')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages' }, payload => {
      if(payload.new.sender_id === activeChat || payload.new.receiver_id === activeChat) displayMessage(payload.new);
    })
    // Public messages
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'public_messages' }, payload => {
      if(chatType==='public') displayMessage(payload.new);
    })
    .subscribe();
}

// ----------------- TYPING INDICATOR -----------------
let typingTimeout;
document.getElementById('messageInput').addEventListener('input', () => {
  setTyping(true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=> setTyping(false), 2000);
});

async function setTyping(state) {
  if(chatType==='public') {
    await supabase.from('typing').upsert({ user_id: currentUser.id, chat_type:'public', target_id:null, is_typing:state, updated_at: new Date() });
  } else if(activeChat) {
    await supabase.from('typing').upsert({ user_id: currentUser.id, chat_type:'private', target_id:activeChat, is_typing:state, updated_at: new Date() });
  }
}

async function subscribeTyping() {
  supabase.channel('typing')
    .on('postgres_changes', { event:'UPDATE', schema:'public', table:'typing' }, payload => {
      const t = payload.new;
      if(chatType==='public' && t.chat_type==='public' && t.user_id!==currentUser.id) {
        document.getElementById('typingIndicator').textContent = t.is_typing ? "Someone is typing..." : "";
      } else if(chatType==='private' && t.chat_type==='private' && t.target_id===currentUser.id) {
        document.getElementById('typingIndicator').textContent = t.is_typing ? "Friend is typing..." : "";
      }
    })
    .subscribe();
}
</script>
</body>
</html>
