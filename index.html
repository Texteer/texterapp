<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dark Chat App</title>
<style>
  body { margin:0; font-family:sans-serif; background:#0b0f1a; color:#fff; }
  header { background:#101426; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
  main { display:flex; height:90vh; }
  #friends { width:250px; background:#141a2c; padding:1rem; overflow-y:auto; display:flex; flex-direction:column; }
  #friendSearch { margin-bottom:1rem; }
  #friendSearch input { width:100%; padding:0.5rem; border-radius:4px; border:none; }
  #chat { flex:1; display:flex; flex-direction:column; background:#0d1326; }
  #chatHeader { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 1rem; background:#101426; }
  #backBtn { display:none; cursor:pointer; color:#0b78e3; font-weight:bold; }
  #messages { flex:1; padding:1rem; overflow-y:auto; }
  #input { display:flex; padding:0.5rem; background:#101426; }
  #input input { flex:1; padding:0.5rem; border:none; border-radius:4px 0 0 4px; }
  #input button { background:#0b78e3; color:#fff; border-radius:0 4px 4px 0; border:none; }
  .message { margin-bottom:0.5rem; padding:0.5rem; border-radius:10px; max-width:60%; display:inline-block; word-break:break-word; }
  .message.self { background:#0b78e3; color:#fff; align-self:flex-end; }
  .message.other { background:#1c2335; color:#fff; align-self:flex-start; }
  .timestamp { font-size:0.7rem; color:#7a7a7a; margin-top:2px; display:block; }
  .friend { padding:0.5rem; border-bottom:1px solid #1c2335; cursor:pointer; display:flex; justify-content:space-between; }
  .friend:hover { background:#1c2335; }
  #typingIndicator { font-size:0.9rem; color:#7a7a7a; margin-bottom:0.5rem; }
  /* Login/Signup modal */
  #authModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:10; }
  #authBox { background:#101426; padding:2rem; border-radius:8px; width:300px; display:flex; flex-direction:column; }
  #authBox input { margin-bottom:1rem; padding:0.5rem; border-radius:4px; border:none; }
  #authBox button { padding:0.5rem; border:none; border-radius:4px; background:#0b78e3; color:#fff; cursor:pointer; margin-top:0.5rem; }
  #toggleAuth { margin-top:1rem; text-align:center; color:#0b78e3; cursor:pointer; }
</style>
</head>
<body>

<header>
  <div>Dark Chat</div>
  <button id="logout-btn" style="display:none;">Logout</button>
</header>

<main>
  <div id="friends">
    <div id="friendSearch">
      <input type="text" id="searchInput" placeholder="Search friends by name/email">
    </div>
    <div id="friendList"></div>
    <button id="addFriendBtn">Add Friend</button>
  </div>
  <div id="chat">
    <div id="chatHeader">
      <span id="backBtn">&larr; Back</span>
      <span id="chatTitle">Global Chat</span>
    </div>
    <div id="typingIndicator"></div>
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</main>

<!-- Auth Modal -->
<div id="authModal">
  <div id="authBox">
    <h2 id="authTitle">Login</h2>
    <input type="email" id="authEmail" placeholder="Email">
    <input type="text" id="authUsername" placeholder="Username" style="display:none;">
    <input type="password" id="authPassword" placeholder="Password">
    <button id="authBtn">Login</button>
    <div id="toggleAuth">Don't have an account? Sign Up</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://azpgwbxillscpwrraprl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cGd3YnhpbGxzY3B3cnJhcHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg1MjQsImV4cCI6MjA3MjYzNDUyNH0.h7ZDxtH4pB3K5IzRB9goLJ1ldrY6EGf7CWT-ELGQ0i0';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;
let activeChat = null; // null = global
let typingTimeout;

// ----------------- AUTH -----------------
const authModal = document.getElementById('authModal');
const authTitle = document.getElementById('authTitle');
const authUsername = document.getElementById('authUsername');
const authBtn = document.getElementById('authBtn');
const toggleAuth = document.getElementById('toggleAuth');

let isLogin = true;

toggleAuth.onclick = () => {
  isLogin = !isLogin;
  authTitle.textContent = isLogin ? 'Login' : 'Sign Up';
  authBtn.textContent = isLogin ? 'Login' : 'Sign Up';
  authUsername.style.display = isLogin ? 'none' : 'block';
  toggleAuth.textContent = isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
};

authBtn.onclick = async () => {
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  const username = document.getElementById('authUsername').value;

  if(isLogin){
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) return alert(error.message);
    currentUser = data.user;
    authModal.style.display = 'none';
    document.getElementById('logout-btn').style.display = 'inline';
    initApp();
  } else {
    const { data, error } = await supabase.auth.signUp({ email, password });
    if(error) return alert(error.message);
    await supabase.from('users').insert([{ id: data.user.id, username }]);
    alert('Signed up! Please login.');
  }
};

document.getElementById('logout-btn').onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

// ----------------- INITIALIZE APP -----------------
async function initApp(){
  loadFriends();
  loadMessages();
  subscribeMessages();
  subscribeTyping();
}

// ----------------- FRIEND SYSTEM -----------------
const friendListEl = document.getElementById('friendList');
const searchInput = document.getElementById('searchInput');
document.getElementById('addFriendBtn').onclick = async () => {
  const emailOrUsername = prompt('Enter friend email or username:');
  if(!emailOrUsername) return;
  const { data: user } = await supabase.from('users').select('id').or(`email.eq.${emailOrUsername},username.eq.${emailOrUsername}`).single();
  if(!user) return alert('User not found');
  await supabase.from('friends').insert([{ user_id: currentUser.id, friend_id: user.id, status:'pending' }]);
  loadFriends();
};

searchInput.addEventListener('input', loadFriends);

async function loadFriends(){
  const { data: friendsData } = await supabase.from('friends').select('*,users!inner(username,email)').or(`user_id.eq.${currentUser.id},friend_id.eq.${currentUser.id}`);
  friendListEl.innerHTML = '';
  friendsData.forEach(f=>{
    const friendId = f.user_id === currentUser.id ? f.friend_id : f.user_id;
    const friendName = f.users.username;
    if(searchInput.value && !friendName.toLowerCase().includes(searchInput.value.toLowerCase()) && !f.users.email.includes(searchInput.value)) return;
    const div = document.createElement('div');
    div.className = 'friend';
    div.textContent = friendName + (f.status==='pending' && f.user_id!==currentUser.id ? ' (Accept)' : '');
    div.onclick = async ()=>{
      if(f.status==='pending' && f.user_id!==currentUser.id){
        await supabase.from('friends').update({status:'accepted'}).eq('id',f.id);
        loadFriends();
      } else if(activeChat===friendId){
        activeChat=null;
        document.getElementById('chatTitle').textContent='Global Chat';
        document.getElementById('backBtn').style.display='none';
        loadMessages();
      } else {
        activeChat=friendId;
        document.getElementById('chatTitle').textContent=friendName;
        document.getElementById('backBtn').style.display='inline';
        loadMessages();
      }
    };
    friendListEl.appendChild(div);
  });
}

// ----------------- BACK TO GLOBAL CHAT -----------------
document.getElementById('backBtn').onclick = () => {
  activeChat=null;
  document.getElementById('chatTitle').textContent='Global Chat';
  document.getElementById('backBtn').style.display='none';
  loadMessages();
};

// ----------------- MESSAGES -----------------
async function loadMessages(){
  const messagesEl = document.getElementById('messages');
  messagesEl.innerHTML='';
  if(!activeChat){
    const { data: msgs } = await supabase.from('public_messages').select('*,users!inner(username)').order('created_at',{ascending:true});
    msgs.forEach(m=>{
      const div = document.createElement('div');
      div.className='message ' + (m.sender_id===currentUser.id?'self':'other');
      div.innerHTML=`${m.users.username}: ${m.message}<span class="timestamp">${new Date(m.created_at).toLocaleTimeString()}</span>`;
      messagesEl.appendChild(div);
      div.scrollIntoView();
    });
  } else {
    const { data: msgs } = await supabase.from('messages').select('*,users!inner(username)').or(`(sender_id.eq.${currentUser.id},receiver_id.eq.${activeChat}),(sender_id.eq.${activeChat},receiver_id.eq.${currentUser.id})`).order('created_at',{ascending:true});
    msgs.forEach(m=>{
      const div = document.createElement('div');
      div.className='message ' + (m.sender_id===currentUser.id?'self':'other');
      div.innerHTML=`${m.users.username}: ${m.message}<span class="timestamp">${new Date(m.created_at).toLocaleTimeString()}</span>`;
      messagesEl.appendChild(div);
      div.scrollIntoView();
    });
  }
}

// ----------------- SEND MESSAGE -----------------
document.getElementById('sendBtn').onclick = async () => {
  const input=document.getElementById('messageInput');
  if(!input.value) return;
  if(!activeChat){
    await supabase.from('public_messages').insert([{ sender_id: currentUser.id, message: input.value }]);
  } else {
    await supabase.from('messages').insert([{ sender_id: currentUser.id, receiver_id: activeChat, message: input.value }]);
  }
  input.value='';
  setTyping(false);
};

// ----------------- REALTIME -----------------
function subscribeMessages(){
  supabase.channel('messages')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},payload=>{
      const m=payload.new;
      if(activeChat && (m.sender_id===activeChat || m.receiver_id===activeChat)) loadMessages();
    })
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'public_messages'},payload=>{
      if(!activeChat) loadMessages();
    }).subscribe();
}

// ----------------- TYPING -----------------
document.getElementById('messageInput').addEventListener('input',()=>{
  setTyping(true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>setTyping(false),2000);
});

async function setTyping(state){
  if(!activeChat){
    await supabase.from('typing').upsert({ user_id: currentUser.id, chat_type:'public', target_id:null, is_typing:state, updated_at:new Date() });
  } else {
    await supabase.from('typing').upsert({ user_id: currentUser.id, chat_type:'private', target_id:activeChat, is_typing:state, updated_at:new Date() });
  }
}

async function subscribeTyping(){
  supabase.channel('typing')
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'typing'},payload=>{
      const t=payload.new;
      const typingEl=document.getElementById('typingIndicator');
      if(!activeChat && t.chat_type==='public' && t.user_id!==currentUser.id){
        typingEl.textContent=t.is_typing?'Someone is typing...':'';
      } else if(activeChat && t.chat_type==='private' && t.target_id===currentUser.id){
        typingEl.textContent=t.is_typing?'Friend is typing...':'';
      }
    }).subscribe();
}

// ----------------- CHECK AUTH STATE -----------------
supabase.auth.getSession().then(({ data })=>{
  if(data.session && data.session.user){
    currentUser=data.session.user;
    authModal.style.display='none';
    document.getElementById('logout-btn').style.display='inline';
    initApp();
  }
});
</script>

</body>
</html>
