<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Supabase Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0d0d0d, #0b1a33);
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #appContainer {
      width: 95%;
      max-width: 600px;
      background: #111827;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      padding: 20px;
    }
    h2, h3 {
      color: #60a5fa;
      text-align: center;
    }
    #messages {
      border: 1px solid #1f2937;
      height: 300px;
      overflow-y: auto;
      background: #0d1117;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    input, button, select {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border-radius: 6px;
      border: none;
      outline: none;
      font-size: 14px;
    }
    input {
      background: #1f2937;
      color: #e0e0e0;
    }
    button {
      background: #2563eb;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #1d4ed8;
    }
    #chatDiv, #adminDiv, #usernameSetupDiv { display: none; }
    p { margin: 5px 0; }
  </style>
</head>
<body>
  <div id="appContainer">
    <h2>Supabase Chat</h2>

    <!-- Login -->
    <div id="loginDiv">
      <h3>Login</h3>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Password">
      <button id="loginBtn">Login</button>
    </div>

    <!-- Username setup -->
    <div id="usernameSetupDiv">
      <h3>Create Your Username</h3>
      <input type="text" id="newUsernameInput" placeholder="Choose a username (max 15 chars)">
      <button id="saveUsernameBtn">Save Username</button>
    </div>

    <!-- Chat -->
    <div id="chatDiv">
      <h3>Welcome, <span id="displayUsername"></span></h3>
      <div id="messages"></div>
      <input type="text" id="message" placeholder="Type your message and press Enter">
      <button id="sendBtn">Send</button>
    </div>

    <!-- Admin Panel -->
    <div id="adminDiv">
      <h3>Admin Panel</h3>
      <input type="text" id="newUsername" placeholder="New Username">
      <input type="email" id="newEmail" placeholder="New User Email">
      <input type="password" id="newPassword" placeholder="New User Password">
      <select id="newRole">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
      <button id="createUserBtn">Create User</button>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const client = supabase.createClient(
      "https://fhokwoazuhkwrkrweddd.supabase.co", 
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc"
    );

    let currentUser = null;
    let currentUsername = null;
    let currentRole = null;

    // Login
    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      if (!email || !password) { alert("Enter email & password"); return; }

      const { data, error } = await client.auth.signInWithPassword({ email, password });
      if (error) { alert("Login failed: " + error.message); return; }

      currentUser = data.user;

      // Lookup username by email
      const { data: userRow } = await client.from('users').select('username, role').eq('email', currentUser.email).single();

      document.getElementById('loginDiv').style.display = 'none'; // hide login

      if (!userRow || !userRow.username) {
        document.getElementById('usernameSetupDiv').style.display = 'block';
        return;
      }

      currentUsername = userRow.username;
      currentRole = userRow.role;
      enterChat();
    };

    // Save Username
    document.getElementById('saveUsernameBtn').onclick = async () => {
      const newUsername = document.getElementById('newUsernameInput').value.trim();

      if (!newUsername) { alert("Username cannot be empty"); return; }
      if (newUsername.length > 15) { alert("Max 15 chars"); return; }
      if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) { alert("Only letters, numbers, underscores"); return; }

      const { error } = await client.from('users').insert({ email: currentUser.email, username: newUsername, role: 'user' });
      if (error) { alert("Error saving username: " + error.message); return; }

      currentUsername = newUsername;
      currentRole = 'user';
      document.getElementById('usernameSetupDiv').style.display = 'none';
      enterChat();
    };

    // Enter Chat
    function enterChat() {
      document.getElementById('chatDiv').style.display = 'block';
      document.getElementById('displayUsername').innerText = currentUsername;
      if (currentRole === 'admin') document.getElementById('adminDiv').style.display = 'block';
      loadMessages();
      setupRealtime();
    }

    // Load messages
    async function loadMessages() {
      const { data } = await client.from('messages').select('*').order('created_at', { ascending: true });
      const msgDiv = document.getElementById('messages');
      msgDiv.innerHTML = '';
      data.forEach(addMessage);
    }

    function addMessage(msg) {
      const msgDiv = document.getElementById('messages');
      const p = document.createElement('p');
      p.textContent = msg.username + ": " + msg.message;
      msgDiv.appendChild(p);
      msgDiv.scrollTop = msgDiv.scrollHeight;
    }

    // Realtime
    function setupRealtime() {
      client.channel('room1')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          addMessage(payload.new);
        })
        .subscribe();
    }

    // Send message
    async function sendMessage() {
      const message = document.getElementById('message').value.trim();
      if (!message) return;
      const { error } = await client.from('messages').insert({ username: currentUsername, message });
      if (!error) document.getElementById('message').value = '';
    }

    document.getElementById('sendBtn').onclick = sendMessage;

    // Press Enter to send
    document.getElementById('message').addEventListener("keydown", e => {
      if (e.key === "Enter") { e.preventDefault(); sendMessage(); }
    });

    // Admin: Create User
    document.getElementById('createUserBtn').onclick = async () => {
      const username = document.getElementById('newUsername').value.trim();
      const email = document.getElementById('newEmail').value.trim();
      const password = document.getElementById('newPassword').value.trim();
      const role = document.getElementById('newRole').value;
      if (!username || !email || !password) { alert("Fill all fields"); return; }

      const res = await fetch("https://fhokwoazuhkwrkrweddd.functions.supabase.co/manage-users", {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-admin-secret": "gh31qayobamA#" },
        body: JSON.stringify({ action: "create", email, password, username, role })
      });

      const data = await res.json();
      if (data.error) { alert("Error: " + data.error.message); }
      else { alert("User created!"); }
    };
  </script>
</body>
</html>
