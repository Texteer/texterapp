<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snapchat Style Chat</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      display: flex;
      height: 100vh;
    }
    #sidebar {
      width: 250px;
      background: #161b22;
      border-right: 1px solid #30363d;
      display: flex;
      flex-direction: column;
    }
    #friendsList {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #chatHeader {
      background: #161b22;
      padding: 10px;
      border-bottom: 1px solid #30363d;
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message {
      padding: 8px 12px;
      margin: 4px;
      border-radius: 12px;
      max-width: 70%;
    }
    .me {
      background: #1f6feb;
      align-self: flex-end;
      text-align: right;
    }
    .other {
      background: #30363d;
      align-self: flex-start;
    }
    #typingIndicator {
      font-size: 12px;
      color: #8b949e;
      margin: 5px 10px;
    }
    #inputBar {
      display: flex;
      padding: 10px;
      background: #161b22;
      border-top: 1px solid #30363d;
    }
    #inputBar input {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      margin-right: 8px;
      background: #21262d;
      color: #e6edf3;
    }
    #inputBar button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: #1f6feb;
      color: white;
      cursor: pointer;
    }
    #topButtons {
      padding: 10px;
      display: flex;
      justify-content: space-between;
    }
    #friendRequestsPopup,
    #addFriendPopup {
      position: absolute;
      top: 60px;
      left: 260px;
      background: #161b22;
      border: 1px solid #30363d;
      padding: 10px;
      border-radius: 8px;
      display: none;
      z-index: 10;
      width: 250px;
    }
    .friendRequest {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }
    #requestBadge {
      background: red;
      color: white;
      font-size: 12px;
      border-radius: 50%;
      padding: 2px 6px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="topButtons">
      <button onclick="toggleAddFriend()">âž•</button>
      <button onclick="toggleRequests()">ðŸ”” <span id="requestBadge"></span></button>
    </div>
    <div id="friendsList"></div>
  </div>
  <div id="main">
    <div id="chatHeader"><h2 id="chatTitle">Global Chat</h2></div>
    <div id="messages"></div>
    <div id="typingIndicator"></div>
    <div id="inputBar">
      <input id="messageInput" placeholder="Type a message..." onkeydown="handleTyping(event)">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <div id="addFriendPopup">
    <h3>Add Friend</h3>
    <input id="friendEmail" placeholder="Friend's email">
    <button onclick="sendFriendRequest()">Send Request</button>
    <button onclick="toggleAddFriend()">Close</button>
  </div>

  <div id="friendRequestsPopup">
    <h3>Friend Requests</h3>
    <div id="requestsList"></div>
    <button onclick="toggleRequests()">Close</button>
  </div>

  <script>
    const SUPABASE_URL = "YOUR_URL";
    const SUPABASE_KEY = "YOUR_ANON_KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let currentChat = "global";
    let typingUsers = new Set();

    // --- Login Flow ---
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (session) {
        currentUser = session.user;
        loadMessages();
        subscribeMessages();
        subscribeTyping();
        subscribeRequests();
      } else {
        const email = prompt("Enter email:");
        const password = prompt("Enter password:");
        await supabase.auth.signInWithPassword({ email, password });
      }
    });

    // --- Messaging ---
    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text) return;

      await supabase.from("messages").insert([
        { chat: currentChat, user_id: currentUser.id, content: text }
      ]);
      input.value = "";
      stopTyping();
    }

    async function loadMessages() {
      const { data } = await supabase.from("messages").select("*").eq("chat", currentChat).order("created_at");
      renderMessages(data);
    }

    function renderMessages(msgs) {
      const box = document.getElementById("messages");
      box.innerHTML = "";
      msgs.forEach(m => {
        const div = document.createElement("div");
        div.classList.add("message");
        div.classList.add(m.user_id === currentUser.id ? "me" : "other");
        div.innerText = m.content;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }

    function subscribeMessages() {
      supabase.channel("messages")
        .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => {
          if (payload.new.chat === currentChat) {
            const box = document.getElementById("messages");
            const div = document.createElement("div");
            div.classList.add("message");
            div.classList.add(payload.new.user_id === currentUser.id ? "me" : "other");
            div.innerText = payload.new.content;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
          }
        })
        .subscribe();
    }

    // --- Typing Indicator ---
    function handleTyping(e) {
      if (e.key === "Enter") {
        sendMessage();
        return;
      }
      supabase.from("typing").upsert([{ chat: currentChat, user_id: currentUser.id }]);
    }

    function stopTyping() {
      supabase.from("typing").delete().eq("user_id", currentUser.id).eq("chat", currentChat);
    }

    function subscribeTyping() {
      supabase.channel("typing")
        .on("postgres_changes", { event: "*", schema: "public", table: "typing" }, payload => {
          if (payload.new && payload.new.user_id !== currentUser.id) {
            typingUsers.add(payload.new.user_id);
          } else if (payload.eventType === "DELETE") {
            typingUsers.delete(payload.old.user_id);
          }
          updateTypingIndicator();
        })
        .subscribe();
    }

    function updateTypingIndicator() {
      const indicator = document.getElementById("typingIndicator");
      if (typingUsers.size === 0) {
        indicator.innerText = "";
        return;
      }
      const names = Array.from(typingUsers).join(", ");
      indicator.innerText = `${names} is typing...`;
    }

    // --- Friend Requests ---
    function toggleAddFriend() {
      const popup = document.getElementById("addFriendPopup");
      popup.style.display = popup.style.display === "none" ? "block" : "none";
    }

    function toggleRequests() {
      const popup = document.getElementById("friendRequestsPopup");
      popup.style.display = popup.style.display === "none" ? "block" : "none";
    }

    async function sendFriendRequest() {
      const email = document.getElementById("friendEmail").value;
      if (!email) return;
      await supabase.from("friend_requests").insert([{ from: currentUser.email, to: email }]);
      toggleAddFriend();
    }

    function subscribeRequests() {
      supabase.channel("friend_requests")
        .on("postgres_changes", { event: "INSERT", schema: "public", table: "friend_requests" }, payload => {
          if (payload.new.to === currentUser.email) {
            renderRequests();
          }
        })
        .subscribe();
    }

    async function renderRequests() {
      const { data } = await supabase.from("friend_requests").select("*").eq("to", currentUser.email);
      const list = document.getElementById("requestsList");
      list.innerHTML = "";
      data.forEach(r => {
        const div = document.createElement("div");
        div.classList.add("friendRequest");
        div.innerHTML = `${r.from} 
          <button onclick="acceptRequest('${r.from}')">Accept</button>
          <button onclick="declineRequest('${r.from}')">Decline</button>`;
        list.appendChild(div);
      });
      document.getElementById("requestBadge").innerText = data.length || "";
    }

    async function acceptRequest(from) {
      await supabase.from("friends").insert([{ user: currentUser.email, friend: from }]);
      await supabase.from("friends").insert([{ user: from, friend: currentUser.email }]);
      await supabase.from("friend_requests").delete().eq("from", from).eq("to", currentUser.email);
      renderRequests();
    }

    async function declineRequest(from) {
      await supabase.from("friend_requests").delete().eq("from", from).eq("to", currentUser.email);
      renderRequests();
    }
  </script>
</body>
</html>
