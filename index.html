<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Supabase Chat with Usernames</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; background: #fff; padding: 10px; margin-bottom: 10px; }
    input, button { padding: 10px; margin: 5px 0; }
    #chatDiv, #adminDiv, #usernameSetupDiv { display: none; }
  </style>
</head>
<body>

<h2>Supabase Chat</h2>

<!-- Login -->
<div id="loginDiv">
  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email"><br>
  <input type="password" id="loginPassword" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
</div>

<!-- First-Time Username Setup -->
<div id="usernameSetupDiv">
  <h3>Create Your Username</h3>
  <input type="text" id="newUsernameInput" placeholder="Choose a username (max 15 chars)">
  <button id="saveUsernameBtn">Save Username</button>
</div>

<!-- Chat -->
<div id="chatDiv">
  <h3>Welcome, <span id="displayUsername"></span></h3>
  <div id="messages"></div>
  <input type="text" id="message" placeholder="Type your message">
  <button id="sendBtn">Send</button>
</div>

<!-- Admin Panel -->
<div id="adminDiv">
  <h3>Admin Panel</h3>
  <input type="text" id="newUsername" placeholder="New Username"><br>
  <input type="email" id="newEmail" placeholder="New User Email"><br>
  <input type="password" id="newPassword" placeholder="New User Password"><br>
  <select id="newRole">
    <option value="user">User</option>
    <option value="admin">Admin</option>
  </select><br>
  <button id="createUserBtn">Create User</button>
</div>

<!-- Supabase Library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const client = supabase.createClient(
  "https://fhokwoazuhkwrkrweddd.supabase.co", 
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc"
);

let currentUser = null;
let currentUsername = null;
let currentRole = null;

// --- Login ---
document.getElementById('loginBtn').onclick = async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  if (!email || !password) {
    alert("Enter email & password");
    return;
  }

  const { data, error } = await client.auth.signInWithPassword({ email, password });
  if (error) {
    alert("Login failed: " + error.message);
    return;
  }

  currentUser = data.user;

  // lookup username
  const { data: userRow, error: userError } = await client
    .from('users')
    .select('username, role')
    .eq('id', currentUser.id)
    .single();

  if (userError || !userRow || !userRow.username) {
    // no username yet â†’ prompt setup
    document.getElementById('loginDiv').style.display = 'none';
    document.getElementById('usernameSetupDiv').style.display = 'block';
    return;
  }

  currentUsername = userRow.username;
  currentRole = userRow.role;

  enterChat();
};

// --- Save Username (First Time) ---
document.getElementById('saveUsernameBtn').onclick = async () => {
  const newUsername = document.getElementById('newUsernameInput').value.trim();

  // Validation
  if (!newUsername) {
    alert("Username cannot be empty");
    return;
  }
  if (newUsername.length > 15) {
    alert("Username must be 15 characters or less");
    return;
  }
  if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
    alert("Username can only contain letters, numbers, and underscores");
    return;
  }

  const { error } = await client
    .from('users')
    .insert({ id: currentUser.id, username: newUsername, role: 'user' });

  if (error) {
    alert("Error saving username: " + error.message);
    return;
  }

  currentUsername = newUsername;
  currentRole = 'user';

  document.getElementById('usernameSetupDiv').style.display = 'none';
  enterChat();
};

// --- Enter Chat ---
function enterChat() {
  document.getElementById('chatDiv').style.display = 'block';
  document.getElementById('displayUsername').innerText = currentUsername;

  if (currentRole === 'admin') {
    document.getElementById('adminDiv').style.display = 'block';
  }

  loadMessages();
  setupRealtime();
}

// --- Load messages ---
async function loadMessages() {
  const { data, error } = await client
    .from('messages')
    .select('*')
    .order('created_at', { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  const msgDiv = document.getElementById('messages');
  msgDiv.innerHTML = '';
  data.forEach(addMessage);
}

function addMessage(msg) {
  const msgDiv = document.getElementById('messages');
  const p = document.createElement('p');
  p.textContent = msg.username + ": " + msg.message;
  msgDiv.appendChild(p);
  msgDiv.scrollTop = msgDiv.scrollHeight;
}

// --- Realtime ---
function setupRealtime() {
  client.channel('room1')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
      addMessage(payload.new);
    })
    .subscribe();
}

// --- Send message ---
document.getElementById('sendBtn').onclick = async () => {
  const message = document.getElementById('message').value.trim();
  if (!message) return;

  const { error } = await client
    .from('messages')
    .insert({ username: currentUsername, message });

  if (error) {
    alert("Error: " + error.message);
  } else {
    document.getElementById('message').value = '';
  }
};

// --- Admin: Create User ---
document.getElementById('createUserBtn').onclick = async () => {
  const username = document.getElementById('newUsername').value.trim();
  const email = document.getElementById('newEmail').value.trim();
  const password = document.getElementById('newPassword').value.trim();
  const role = document.getElementById('newRole').value;

  if (!username || !email || !password) {
    alert("Fill all fields");
    return;
  }

  // Call your Edge Function
  const res = await fetch("https://fhokwoazuhkwrkrweddd.functions.supabase.co/manage-users", {
    method: "POST",
    headers: { 
      "Content-Type": "application/json", 
      "x-admin-secret": "gh31qayobamA#" // must match your ADMIN_SECRET
    },
    body: JSON.stringify({ action: "create", email, password, username, role })
  });

  const data = await res.json();
  if (data.error) {
    alert("Error: " + data.error.message);
  } else {
    alert("User created!");
  }
};
</script>
</body>
</html>
