<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Snapchat-Style Chat</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0d1117; color: #fff; }
    #app { display: flex; height: 100vh; }
    #sidebar { width: 250px; background: #161b22; padding: 10px; overflow-y: auto; }
    #chatArea { flex: 1; display: flex; flex-direction: column; background: #0d1117; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; }
    #inputArea { display: flex; padding: 10px; border-top: 1px solid #333; }
    #message { flex: 1; padding: 10px; border: none; border-radius: 5px; }
    .msg { margin: 5px 0; padding: 8px 12px; border-radius: 15px; max-width: 60%; word-wrap: break-word; }
    .msg.mine { background: #1e40af; align-self: flex-end; }
    .msg.theirs { background: #2d3748; align-self: flex-start; }
    .friend { padding: 10px; cursor: pointer; border-radius: 5px; }
    .friend:hover { background: #2d3748; }
    .hidden { display: none; }
    .popup { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: #161b22; border: 1px solid #333; padding: 20px; border-radius: 10px; }
    .btn { background: #1e40af; color: #fff; padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #2563eb; }
    .topbar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #161b22; border-bottom: 1px solid #333; }
    .badge { background: red; color: #fff; border-radius: 50%; padding: 3px 7px; font-size: 12px; margin-left: 5px; }
  </style>
</head>
<body>

<div id="loginDiv">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button id="loginBtn" class="btn">Login</button>
</div>

<div id="app" class="hidden">
  <div id="sidebar">
    <div class="topbar">
      <span>Friends</span>
      <div>
        <button id="showRequestsBtn" class="btn">Requests <span id="reqBadge" class="badge hidden">0</span></button>
        <button id="addFriendBtn" class="btn">+</button>
      </div>
    </div>
    <div id="friendsList"></div>
  </div>
  <div id="chatArea">
    <div class="topbar"><span id="chatTitle">Global Chat</span></div>
    <div id="messages"></div>
    <div id="inputArea">
      <input type="text" id="message" placeholder="Type a message...">
    </div>
  </div>
</div>

<!-- Add Friend Popup -->
<div id="addFriendPopup" class="popup hidden">
  <h3>Add Friend</h3>
  <input type="text" id="friendEmail" placeholder="Friend's email"><br>
  <button id="sendFriendReq" class="btn">Send Request</button>
  <button id="closeAddFriend" class="btn">X</button>
</div>

<!-- Requests Popup -->
<div id="requestsPopup" class="popup hidden">
  <h3>Friend Requests</h3>
  <div id="requestsList"></div>
  <button id="closeRequests" class="btn">X</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const client = supabase.createClient(
    "https://fhokwoazuhkwrkrweddd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc"
  );

  let currentUser = null;
  let currentChat = { type: "global", id: null };

  async function init() {
    const { data } = await client.auth.getSession();
    if (data.session) {
      currentUser = data.session.user;
      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      loadFriends();
      subscribeToMessages();
      loadMessages();
    }
  }

  document.getElementById("loginBtn").onclick = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const { data, error } = await client.auth.signInWithPassword({ email, password });
    if (error) { alert(error.message); return; }
    currentUser = data.user;
    document.getElementById("loginDiv").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    loadFriends();
    subscribeToMessages();
    loadMessages();
  };

  async function loadMessages() {
    document.getElementById("messages").innerHTML = "";
    let query = client.from("messages").select("*").order("created_at", { ascending: true });
    if (currentChat.type === "dm") query = query.eq("chat_id", currentChat.id);
    const { data } = await query;
    data.forEach(renderMessage);
  }

  function renderMessage(msg) {
    const div = document.createElement("div");
    div.classList.add("msg");
    div.classList.add(msg.sender_id === currentUser.id ? "mine" : "theirs");
    div.textContent = msg.content;
    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  }

  function subscribeToMessages() {
    client.channel("public:messages")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => {
        if (currentChat.type === "global" && !payload.new.chat_id) renderMessage(payload.new);
        if (currentChat.type === "dm" && payload.new.chat_id === currentChat.id) renderMessage(payload.new);
      })
      .subscribe();
  }

  document.getElementById("message").addEventListener("keydown", async (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const content = e.target.value.trim();
      if (!content) return;
      const { error } = await client.from("messages").insert({
        sender_id: currentUser.id,
        content,
        chat_id: currentChat.type === "dm" ? currentChat.id : null
      });
      if (!error) e.target.value = "";
    }
  });

  async function loadFriends() {
    document.getElementById("friendsList").innerHTML = "";
    const { data } = await client.from("friends").select("*").or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
    data.forEach(f => {
      const div = document.createElement("div");
      div.classList.add("friend");
      const friendId = f.user1 === currentUser.id ? f.user2 : f.user1;
      div.textContent = "Friend: " + friendId;
      div.onclick = () => {
        currentChat = { type: "dm", id: f.chat_id };
        document.getElementById("chatTitle").textContent = "Private Chat";
        loadMessages();
      };
      document.getElementById("friendsList").appendChild(div);
    });
  }

  // Add friend popup toggle
  document.getElementById("addFriendBtn").onclick = () => {
    document.getElementById("addFriendPopup").classList.toggle("hidden");
  };
  document.getElementById("closeAddFriend").onclick = () => {
    document.getElementById("addFriendPopup").classList.add("hidden");
  };

  // Requests popup toggle
  document.getElementById("showRequestsBtn").onclick = () => {
    document.getElementById("requestsPopup").classList.toggle("hidden");
  };
  document.getElementById("closeRequests").onclick = () => {
    document.getElementById("requestsPopup").classList.add("hidden");
  };

  init();
</script>

</body>
</html>
