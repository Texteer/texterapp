<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supabase Chat with Admin</title>
<style>
  body { font-family: Arial; padding: 20px; background: #f0f0f0; }
  #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; background: #fff; padding: 10px; margin-bottom: 10px; }
  input[type=text], input[type=password] { width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
  button { padding: 10px 20px; cursor: pointer; margin-right:5px; }
  #adminPanel { display:none; border:1px solid #ccc; padding:10px; margin-bottom:10px; background:#eee;}
</style>
</head>
<body>

<h2>Login</h2>
<div id="loginDiv">
  <input type="text" id="loginEmail" placeholder="Email" />
  <input type="password" id="loginPassword" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
</div>

<div id="chatDiv" style="display:none;">
  <h2>Supabase Chat</h2>
  <div id="adminPanel">
    <h3>Admin Panel</h3>
    <input type="text" id="newUserEmail" placeholder="New user email">
    <input type="text" id="newUserPassword" placeholder="New user password">
    <select id="newUserRole"><option value="user">User</option><option value="admin">Admin</option></select>
    <button id="createUserBtn">Create User</button>
    <h4>Existing Users</h4>
    <ul id="userList"></ul>
  </div>
  <input type="text" id="message" placeholder="Type your message" />
  <button id="sendBtn">Send</button>
  <div id="messages"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://fhokwoazuhkwrkrweddd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc';
const client = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;

// Login
document.getElementById('loginBtn').onclick = async () => {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const { data, error } = await client.auth.signInWithPassword({ email, password });
  if(error){ alert('Login failed: '+error.message); return; }
  currentUser = data.user;
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('chatDiv').style.display='block';
  document.getElementById('logoutBtn').style.display='inline';
  loadMessages();
  setupRealtime();
  checkAdmin();
}

// Logout
document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  currentUser=null;
  document.getElementById('loginDiv').style.display='block';
  document.getElementById('chatDiv').style.display='none';
  document.getElementById('logoutBtn').style.display='none';
}

// Chat
const messagesDiv = document.getElementById('messages');
document.getElementById('sendBtn').onclick = async () => {
  const message = document.getElementById('message').value.trim();
  if(!message) return;
  const { error } = await client.from('messages').insert([{ username:currentUser.email, message }]);
  if(error) alert('Error: '+error.message);
  else document.getElementById('message').value='';
}

async function loadMessages(){
  const { data } = await client.from('messages').select('*').order('created_at',{ascending:true});
  messagesDiv.innerHTML='';
  data.forEach(d=>{const p=document.createElement('p'); p.textContent=d.username+': '+d.message; messagesDiv.appendChild(p);});
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Realtime
function setupRealtime(){
  client.channel('room1').on('postgres_changes',{ event:'INSERT', schema:'public', table:'messages' },payload=>{
    const p=document.createElement('p'); p.textContent=payload.new.username+': '+payload.new.message; messagesDiv.appendChild(p);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }).subscribe();
}

// Admin panel
async function checkAdmin(){
  // Simple check: look for user in users table with role=admin
  const { data } = await client.from('users').select('*').eq('id', currentUser.id).single();
  if(data && data.role==='admin'){
    document.getElementById('adminPanel').style.display='block';
    loadUsers();
  }
}

async function loadUsers(){
  const { data } = await client.from('users').select('*');
  const list = document.getElementById('userList'); list.innerHTML='';
  data.forEach(u=>{
    const li=document.createElement('li');
    li.textContent=u.username+' ('+u.role+')';
    const delBtn=document.createElement('button'); delBtn.textContent='Delete';
    delBtn.onclick=async()=>{ await client.auth.admin.deleteUser(u.id); loadUsers(); };
    li.appendChild(delBtn);
    list.appendChild(li);
  });
}

// Create user (admin only)
document.getElementById('createUserBtn').onclick=async()=>{
  const email=document.getElementById('newUserEmail').value.trim();
  const password=document.getElementById('newUserPassword').value.trim();
  const role=document.getElementById('newUserRole').value;
  if(!email||!password) return alert('Email and password required');
  const { data, error } = await client.auth.admin.createUser({ email, password });
  if(error) return alert('Error: '+error.message);
  // Add to users table
  await client.from('users').insert([{ id:data.user.id, username:email, role }]);
  loadUsers();
}
</script>
</body>
</html>
