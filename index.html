<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Texter â€” Desktop Chat App</title>
<style>
:root{
  --bg:#0b1020; --panel:#121a2b; --panel-2:#0f172a; --accent:#3b82f6; --text:#e5e7eb;
  --muted:#8aa0c6; --border:#1f2a44; --me:#2563eb; --them:#1f2937; --danger:#ef4444; --success:#22c55e;
}
*{box-sizing:border-box;}
html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);}
.app{width:100%; max-width:1100px; height:92vh; display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr auto; grid-template-areas:"header header" "sidebar chat" "sidebar input"; background:var(--bg); border:1px solid var(--border); border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.4);}
header{grid-area:header; background:var(--panel); padding:14px 18px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border);}
.brand{color:var(--accent); font-weight:700;}
.meInfo{color:var(--muted);}
.sidebar{grid-area:sidebar; background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column;}
.sidebar-top{display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--border); align-items:center;}
.results,.friends{overflow:auto; padding-bottom:8px;}
.search input{width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:#071228; color:var(--text);}
.list-item{display:flex; gap:10px; align-items:center; padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.03);}
.list-item:hover{background:#0e1730;}
.avatar{width:36px; height:36px; border-radius:50%; display:grid; place-items:center; font-weight:700; color:#cde1ff; background:#0e2a5a; border:1px solid #18325e;}
.meta .name{font-size:.95rem;}
.meta .muted{color:var(--muted); font-size:.82rem;}
.badge{background:var(--danger); color:white; border-radius:999px; padding:2px 8px; font-size:12px;}
.chat{grid-area:chat; display:flex; flex-direction:column; background:var(--panel-2);}
.chat-header{padding:12px 16px; border-bottom:1px solid var(--border); display:flex; gap:10px; align-items:center;}
.messages{flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px;}
.bubble{max-width:78%; padding:10px 12px; border-radius:12px; line-height:1.3; word-wrap:break-word;}
.bubble.me{align-self:flex-end; background:var(--me); color:white;}
.bubble.them{align-self:flex-start; background:var(--them); color:#e6eefc;}
.bubble .from{display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:.82rem; color:#cdd8ff;}
.composer{grid-area:input; display:flex; gap:10px; padding:12px; background:var(--panel); border-top:1px solid var(--border);}
.composer input{flex:1; padding:12px; border-radius:10px; border:1px solid var(--border); background:#071228; color:var(--text);}
.btn{padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0c1426; color:var(--text); cursor:pointer;}
.btn.primary{background:var(--accent); border-color:transparent;}
.btn.hidden{display:none;}
.overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:60;}
.card{background:var(--panel); padding:18px; border-radius:10px; border:1px solid var(--border); width:95%; max-width:420px;}
.note{color:var(--muted); font-size:.9rem;}
.small{font-size:.85rem; color:var(--muted);}
</style>
</head>
<body>

<!-- AUTH modal -->
<div id="authOverlay" class="overlay" style="display:none;">
  <div class="card">
    <h2 style="color:var(--accent)">Welcome</h2>
    <p class="note">Log in with email & password. First-time users will set a username.</p>
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPassword" type="password" placeholder="Password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="loginBtn" class="btn primary">Log in</button>
      <button id="signupBtn" class="btn">Sign up</button>
    </div>
    <p class="small" style="margin-top:8px">Check console for errors if login fails.</p>
  </div>
</div>

<!-- USERNAME modal -->
<div id="usernameOverlay" class="overlay" style="display:none;">
  <div class="card">
    <h3 style="color:var(--accent)">Pick a username</h3>
    <p class="note">Letters, numbers, underscore. Max 15 characters.</p>
    <input id="usernameField" type="text" placeholder="e.g. alex_99" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="saveUsername" class="btn primary">Save</button>
    </div>
    <p id="usernameError" class="small" style="color:var(--danger);display:none;margin-top:8px"></p>
  </div>
</div>

<!-- MAIN APP -->
<div id="appRoot" class="app" style="display:none;">
  <header>
    <div class="brand">Texter</div>
    <div class="meInfo" id="meInfo">â€”</div>
  </header>

  <aside class="sidebar">
    <div class="sidebar-top">
      <button id="toggleAdd" class="btn">âž• Add</button>
      <button id="toggleReq" class="btn">ðŸ”” Requests <span id="reqCount" class="badge" style="display:none;margin-left:6px">0</span></button>
      <button id="logoutBtn" class="btn" style="margin-left:auto">Sign out</button>
    </div>
    <div style="padding:10px;border-bottom:1px solid var(--border)">
      <div class="search"><input id="searchBox" placeholder="Search usernameâ€¦" /></div>
    </div>
    <div class="friends" id="friendsList" style="padding-bottom:10px"></div>
  </aside>

  <section class="chat">
    <div class="chat-header">
      <div class="avatar" id="roomAvatar">GC</div>
      <div class="chat-title" id="roomTitle">Global Chat</div>
    </div>
    <div class="messages" id="messages"></div>
  </section>

  <div class="composer">
    <input id="composerInput" placeholder="Type a messageâ€¦ (Enter to send)" />
    <button id="sendMobileBtn" class="btn primary send-mobile">Send</button>
  </div>
</div>

<!-- Add friend popup -->
<div id="addPopup" style="position:fixed; left:22px; top:70px; width:300px; display:none; z-index:50">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Add friends</strong></div>
      <button id="closeAdd" class="btn">X</button>
    </div>
    <div style="margin-top:10px">
      <input id="addSearch" placeholder="Search username" />
      <div id="addResults" style="margin-top:8px; max-height:260px; overflow:auto"></div>
    </div>
  </div>
</div>

<!-- Requests popup -->
<div id="reqPopup" style="position:fixed; left:22px; top:70px; width:300px; display:none; z-index:50">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Requests</strong></div>
      <button id="closeReq" class="btn">X</button>
    </div>
    <div id="reqList" style="margin-top:10px; max-height:320px; overflow:auto"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://fhokwoazuhkwrkrweddd.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = id => document.getElementById(id);

let session = null;
let me = { email:null, username:null };
let currentView = { type: 'global', peerEmail: null, peerUsername: null };
let messagesDedup = new Set();
let globalChannel = null;
let dmChannel = null;

const initials = s=>{ const parts = String(s).split(/[\s_]+/).filter(Boolean); return (parts[0]||'')[0] + ((parts[1]||'')[0]||''); };
const escapeHtml = s => (s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));

(async function boot(){
  const { data: { session: s } } = await sb.auth.getSession();
  session = s;
  if(session && session.user){ await afterLogin(session.user); }
  else { showAuth(); }
})();

sb.auth.onAuthStateChange((event,s)=>{
  if(event==='SIGNED_OUT'){ me={email:null,username:null}; messagesDedup.clear(); showAuth(); }
  if(s && s.user){ session=s; }
});

function showAuth(){ $('authOverlay').style.display='flex'; $('usernameOverlay').style.display='none'; $('appRoot').style.display='none'; }
function showUsername(){ $('authOverlay').style.display='none'; $('usernameOverlay').style.display='flex'; $('appRoot').style.display='none'; }
function showApp(){ $('authOverlay').style.display='none'; $('usernameOverlay').style.display='none'; $('appRoot').style.display='grid'; }

$('loginBtn').addEventListener('click', async ()=>{
  const email=$('loginEmail').value.trim(); const password=$('loginPassword').value;
  if(!email||!password) return alert("Enter email & password");
  const { data,error } = await sb.auth.signInWithPassword({ email,password });
  if(error) return alert("Login error: "+error.message);
  await afterLogin(data.user);
});

$('signupBtn').addEventListener('click', async ()=>{
  const email=$('loginEmail').value.trim(); const password=$('loginPassword').value;
  if(!email||!password) return alert("Enter email & password");
  const { data,error } = await sb.auth.signUp({ email,password });
  if(error) return alert("Signup error: "+error.message);
  alert("Signed up. Then log in.");
});

async function afterLogin(user){
  me.email=user.email;
  const { data: row } = await sb.from('users').select('username').eq('email',me.email).maybeSingle();
  if(!row || !row.username){ $('usernameField').value=''; $('usernameError').style.display='none'; showUsername(); }
  else{ me.username=row.username; showApp(); startApp(); }
}

$('saveUsername').addEventListener('click', async ()=>{
  const u=$('usernameField').value.trim();
  if(!/^[A-Za-z0-9_]{1,15}$/.test(u)){ $('usernameError').innerText="Invalid username"; $('usernameError').style.display='block'; return; }
  const { data: exists } = await sb.from('users').select('email').eq('username', u).maybeSingle();
  if(exists){ $('usernameError').innerText="Username taken"; $('usernameError').style.display='block'; return; }
  const { error } = await sb.from('users').upsert({ email:me.email, username:u },{ onConflict:'email' });
  if(error) return alert("Could not save username");
  me.username=u; showApp(); startApp();
});

$('logoutBtn').addEventListener('click', async ()=>{ await sb.auth.signOut(); messagesDedup.clear(); $('messages').innerHTML=''; showAuth(); });

function startApp(){
  $('meInfo').innerText = `${me.username} â€” ${me.email}`;
  messagesDedup.clear();
  loadGlobalMessages(); subscribeGlobal(); wireComposer(); wireSidebar(); loadFriends(); loadRequests();
}

function messageKey(msg){ return `${msg.sender_email||''}::${msg.message||msg.content||''}::${msg.created_at||Date.now()}`; }

async function loadGlobalMessages(){
  const { data } = await sb.from('messages').select('*').order('created_at',{ ascending:true });
  $('messages').innerHTML='';
  for(const m of data||[]){ addMessageToUI(m); }
}

function addMessageToUI(m){
  const key=messageKey(m); if(messagesDedup.has(key)) return; messagesDedup.add(key);
  const container=$('messages'); const mine=(m.sender_email===me.email);
  const div=document.createElement('div'); div.className='bubble '+(mine?'me':'them');
  const displayName=(m.username||m.sender_email||'Unknown');
  if(!mine){ div.innerHTML=`<div class="from"><div class="avatar" style="width:26px;height:26px;font-size:.8rem">${escapeHtml(initials(displayName))}</div><div>${escapeHtml(displayName)}</div></div><div>${escapeHtml(m.message||m.content||'')}</div>`; }
  else{ div.innerHTML=`<div>${escapeHtml(m.message||m.content||'')}</div>`; }
  container.appendChild(div); container.scrollTop=container.scrollHeight;
}

function subscribeGlobal(){
  if(globalChannel){ sb.removeChannel(globalChannel); globalChannel=null; messagesDedup.clear(); }
  globalChannel = sb.channel('public:messages')
    .on('postgres_changes',{ event:'INSERT', schema:'public', table:'messages' }, payload=>addMessageToUI(payload.new))
    .subscribe();
}

function wireComposer(){
  const input=$('composerInput');
  input.addEventListener('keydown', async (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); } });
  $('sendMobileBtn').addEventListener('click', async ()=>sendMessage());
}

async function sendMessage(){
  const txt=$('composerInput').value.trim(); if(!txt) return;
  if(currentView.type==='global'){
    const payload={ username: me.username||me.email, message:txt, sender_email:me.email };
    const { data,error } = await sb.from('messages').insert([payload]).select();
    if(error) return alert("Failed to send message: "+error.message);
    if(data && data[0]) addMessageToUI(data[0]);
    $('composerInput').value='';
  }
}

function wireSidebar(){ /* Implement Add/Search/Requests wiring here as in previous code */ }
async function loadFriends(){ /* Load friends from supabase */ }
async function loadRequests(){ /* Load friend requests */ }

</script>
</body>
</html>
