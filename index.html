<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta charset="utf-8" />
  <title>Texter â€” Global & DMs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020;           /* deep navy */
      --panel:#121a2b;        /* card/nav */
      --panel-2:#0f172a;      /* chat area */
      --accent:#3b82f6;       /* blue */
      --accent-2:#60a5fa;     /* lighter blue */
      --text:#e5e7eb;         /* light */
      --muted:#8aa0c6;        /* muted */
      --border:#1f2a44;       /* lines */
      --me:#1d4ed8;           /* my bubble */
      --them:#1f2937;         /* others bubble */
      --danger:#ef4444;
      --success:#22c55e;
      --bg:#0b1020; --panel:#121a2b; --panel-2:#0f172a; --accent:#3b82f6; --text:#e5e7eb;
      --muted:#8aa0c6; --border:#1f2a44; --me:#1d4ed8; --them:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:linear-gradient(140deg,#000,#0b1a33 45%,#000);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text); height:100vh; display:flex; align-items:center; justify-content:center;
    }
    .app{
      width:100%; max-width:1100px; height:92vh; display:grid; gap:10px;
      grid-template-columns:280px 1fr; grid-template-rows:auto 1fr auto;
      grid-template-areas:
        "header header"
        "sidebar chat"
        "sidebar input";
      background:var(--bg); border:1px solid var(--border); border-radius:14px; overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.4);
    }
    header{
      grid-area:header; background:var(--panel); padding:14px 18px; display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border);
    }
    header .brand{font-weight:700; letter-spacing:.4px; color:var(--accent-2)}
    header .me{font-size:.95rem; color:var(--muted)}
    .sidebar{
      grid-area:sidebar; background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column;
    }
    .section-title{padding:10px 12px; font-size:.82rem; color:var(--muted); border-bottom:1px solid var(--border)}
    .search{padding:10px; border-bottom:1px solid var(--border);}
    .search input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0c1426; color:var(--text);}
    .results, .friends{overflow:auto}
    .list-item{
      display:flex; gap:10px; align-items:center; padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.03);
    }
    body{margin:0;background:linear-gradient(140deg,#000,#0b1a33 45%,#000);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);height:100vh;display:flex;align-items:center;justify-content:center}
    .app{width:100%;max-width:1100px;height:92vh;display:grid;gap:10px;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr auto;grid-template-areas:"header header" "sidebar chat" "sidebar input";background:var(--bg);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.4)}
    header{grid-area:header;background:var(--panel);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
    .brand{font-weight:700;color:#60a5fa}
    .sidebar{grid-area:sidebar;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column}
    .section-title{padding:10px 12px;font-size:.82rem;color:var(--muted);border-bottom:1px solid var(--border)}
    .search{padding:10px;border-bottom:1px solid var(--border)}
    .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0c1426;color:var(--text)}
    .results, .friends{overflow:auto;flex:1}
    .list-item{display:flex;gap:10px;align-items:center;padding:10px 12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.03)}
    .list-item:hover{background:#0e1730}
    .list-item .meta{display:flex; flex-direction:column}
    .meta{display:flex;flex-direction:column}
    .name{font-size:.95rem}
    .muted{color:var(--muted); font-size:.8rem}
    .row{display:flex; align-items:center; gap:8px}
    .btn{
      padding:8px 10px; font-size:.8rem; border-radius:8px; border:1px solid var(--border); background:#0c1426; color:var(--text); cursor:pointer;
    }
    .btn.primary{background:var(--accent); border-color:transparent}
    .btn.success{background:var(--success); border-color:transparent}
    .btn.danger{background:var(--danger); border-color:transparent}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .avatar{
      width:34px; height:34px; border-radius:50%; background:#0e2a5a; display:grid; place-items:center;
      color:#cde1ff; font-weight:700; font-size:.9rem; border:1px solid #18325e;
    }

    .chat{
      grid-area:chat; display:flex; flex-direction:column; background:var(--panel-2);
    }
    .chat-header{
      padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px;
    }
    .muted{color:var(--muted);font-size:.8rem}
    .row{display:flex;align-items:center;gap:8px}
    .btn{padding:8px 10px;font-size:.8rem;border-radius:8px;border:1px solid var(--border);background:#0c1426;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent}
    .btn.success{background:#22c55e;border-color:transparent}
    .btn.danger{background:#ef4444;border-color:transparent}
    .avatar{width:34px;height:34px;border-radius:50%;background:#0e2a5a;display:grid;place-items:center;color:#cde1ff;font-weight:700;font-size:.9rem;border:1px solid #18325e}

    .chat{grid-area:chat;display:flex;flex-direction:column;background:var(--panel-2)}
    .chat-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .chat-title{font-weight:600}
    .messages{
      flex:1; overflow:auto; padding:14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .bubble{
      max-width:72%; padding:10px 12px; border-radius:12px; line-height:1.3; position:relative; word-wrap:break-word;
    }
    .bubble.me{align-self:flex-end; background:var(--me)}
    .bubble.them{align-self:flex-start; background:var(--them)}
    .bubble .from{
      display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:.82rem; color:#cdd8ff;
    }
    .composer{
      grid-area:input; display:flex; gap:10px; padding:12px; background:var(--panel); border-top:1px solid var(--border);
    }
    .composer input{
      flex:1; padding:12px 14px; border-radius:10px; border:1px solid var(--border); background:#0c1426; color:var(--text);
    }
    .messages{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
    .bubble{max-width:72%;padding:10px 12px;border-radius:12px;line-height:1.3;position:relative;word-wrap:break-word}
    .bubble.me{align-self:flex-end;background:var(--me);color:#fff}
    .bubble.them{align-self:flex-start;background:var(--them);color:#e6eefc}
    .bubble .from{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:.82rem;color:#cdd8ff}
    .composer{grid-area:input;display:flex;gap:10px;padding:12px;background:var(--panel);border-top:1px solid var(--border)}
    .composer input{flex:1;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#0c1426;color:var(--text)}
    .send-mobile{display:none}
    @media (max-width:900px){
      .app{grid-template-columns:1fr; grid-template-areas:
        "header"
        "chat"
        "input";
      }
      .sidebar{display:none}
      .send-mobile{display:inline-flex}
    }

    /* auth screens */
    .auth-wrap{width:100%; max-width:420px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .auth h2{margin:0 0 10px}
    .auth input, .auth button{width:100%}
    .auth input{background:#0c1426; border:1px solid var(--border); color:var(--text); padding:12px 14px; border-radius:10px; margin:6px 0}
    .auth button{padding:12px 14px; border-radius:10px; background:var(--accent); border:none; color:#fff; cursor:pointer}
    .note{color:var(--muted); font-size:.85rem}
    @media (max-width:900px){.app{grid-template-columns:1fr;grid-template-areas:"header" "chat" "input";}.sidebar{display:none}.send-mobile{display:inline-flex}}
    .auth-wrap{width:100%;max-width:420px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,.35);margin:12px auto}
    .auth-wrap input{background:#0c1426;border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:10px;margin:6px 0}
    .auth-wrap button{padding:12px 14px;border-radius:10px;background:var(--accent);border:none;color:#fff;cursor:pointer}
    .note{color:var(--muted);font-size:.85rem}
    .small-muted{color:var(--muted);font-size:.78rem}
  </style>
</head>
<body>

<!-- ======================= AUTH (auto-hides if session exists) ======================= -->
<div id="auth" class="auth" style="display:none;">
<!-- Auth screen (auto-hidden if session exists) -->
<div id="authScreen" style="display:none; width:100%; max-width:900px;">
  <div class="auth-wrap">
    <h2 style="color:var(--accent-2)">Welcome back</h2>
    <p class="note">Log in with your email & password. First-time users will be asked to pick a username.</p>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <h2 style="color:#60a5fa;margin:0 0 8px">Welcome</h2>
    <p class="note">Log in with email & password. First-time users pick a username.</p>
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPassword" type="password" placeholder="Password" />
    <button id="loginBtn">Log In</button>
  </div>
</div>

<!-- ======================= USERNAME SETUP (shown if missing) ======================= -->
<div id="usernameSetup" class="auth" style="display:none;">
<!-- Username setup -->
<div id="usernameScreen" style="display:none; width:100%; max-width:900px;">
  <div class="auth-wrap">
    <h2 style="color:var(--accent-2)">Create your username</h2>
    <p class="note">Letters / numbers / underscore. Max 15 chars. Pick something classmates will recognize.</p>
    <input type="text" id="usernameInput" placeholder="e.g. alex_p" />
    <h2 style="color:#60a5fa;margin:0 0 8px">Create your username</h2>
    <p class="note">Letters / numbers / underscore. Max 15 chars.</p>
    <input id="usernameInput" type="text" placeholder="e.g. alex_99" />
    <button id="saveUsernameBtn">Save Username</button>
  </div>
</div>

<!-- ======================= APP ======================= -->
<!-- App -->
<div id="app" class="app" style="display:none;">
  <header>
    <div class="brand">Texter</div>
    <div class="me" id="meInfo">Signed in as â€”</div>
    <div class="me" id="meInfo">Signed in â€”</div>
  </header>

  <!-- Sidebar: search + requests + friends -->
  <aside class="sidebar">
    <div class="section-title">Find friends</div>
    <div class="search">
      <input id="searchBox" type="text" placeholder="Search usernameâ€¦" />
    </div>
    <div class="search"><input id="searchBox" type="text" placeholder="Search usernameâ€¦" /></div>
    <div class="results" id="searchResults"></div>

    <div class="section-title">Requests</div>
    <div class="results" id="requests"></div>

    <div class="section-title">Friends</div>
    <div class="friends" id="friends"></div>
    <div class="section-title">Friends & Requests</div>
    <div style="flex:1; display:flex; flex-direction:column; overflow:auto;">
      <div class="friends results" id="friends"></div>
      <div style="border-top:1px solid var(--border); padding:8px 12px; color:var(--muted); font-size:.82rem">Requests</div>
      <div class="results" id="requests" style="max-height:180px; overflow:auto"></div>
    </div>
  </aside>

  <!-- Chat area -->
  <section class="chat">
    <div class="chat-header">
      <div class="avatar" id="roomAvatar">GC</div>
@@ -168,219 +101,167 @@ <h2 style="color:var(--accent-2)">Create your username</h2>
    <div class="messages" id="messages"></div>
  </section>

  <!-- Composer -->
  <div class="composer">
    <input id="composerInput" type="text" placeholder="Type a messageâ€¦ (Enter to send)" />
    <!-- Mobile send button (desktop hidden) -->
    <input id="composerInput" type="text" placeholder="Type a messageâ€¦ (Enter to send on desktop)" />
    <button id="sendBtn" class="btn primary send-mobile">Send</button>
  </div>
</div>

<!-- ======================= SUPABASE & APP LOGIC ======================= -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*
REQUIRED TABLES (run in Supabase SQL editor if you haven't):

create table if not exists public.users (
  id uuid primary key default uuid_generate_v4(),
  email text unique not null,
  username text unique,
  role text default 'user',
  avatar_url text,
  created_at timestamp with time zone default now()
);

create table if not exists public.messages (
  id bigint generated by default as identity primary key,
  username text not null,
  message text not null,
  sender_email text not null,
  created_at timestamp with time zone default now()
);

-- Friend relationships (Snapchat-style)
create table if not exists public.friends (
  id bigint generated by default as identity primary key,
  requester_email text not null,
  addressee_email text not null,
  status text not null default 'pending', -- 'pending' | 'accepted' | 'declined'
  created_at timestamp with time zone default now(),
  unique (requester_email, addressee_email)
);

-- Direct messages
create table if not exists public.dm_messages (
  id bigint generated by default as identity primary key,
  sender_email text not null,
  receiver_email text not null,
  content text not null,
  created_at timestamp with time zone default now()
);

-- (Optional) RLS to add later. For now keep RLS off while building.
SQL (if you don't have tables) included in earlier file â€” make sure messages, dm_messages, users, friends exist.
*/

const client = supabase.createClient(
  "https://fhokwoazuhkwrkrweddd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc"
);

// ---------- UI helpers ----------
// helpers
const $ = (id)=>document.getElementById(id);
const isMobile = () => matchMedia("(max-width: 900px)").matches || 'ontouchstart' in window;
const isMobile = ()=> matchMedia("(max-width:900px)").matches || 'ontouchstart' in window;
const initials = (name='?')=>{
  const parts = name.trim().split(/[\s_]+/);
  const parts = (name||'').trim().split(/[\s_]+/);
  const a = (parts[0]||'')[0]||'?';
  const b = (parts[1]||'')[0]||'';
  return (a+b).toUpperCase();
};

// ---------- State ----------
let session = null;
let me = { email:null, username:null };
let currentView = { type:"global", peerEmail:null, peerUsername:null };
let dmChannel = null;

// ---------- Auth bootstrap (stay logged in) ----------
// boot: restore session if any
(async function boot(){
  const { data:{ session: s } } = await client.auth.getSession();
  const { data: { session: s } } = await client.auth.getSession();
  session = s;
  if(!session){ // show login
    showSection("auth");
  if(!session){
    $("authScreen").style.display = "block";
  } else {
    await afterLogin(session.user);
  }
})();

// react to token refresh / logout
client.auth.onAuthStateChange(async (event, sess)=>{
  if(event === "SIGNED_OUT"){
  if(event === 'SIGNED_OUT'){
    me = { email:null, username:null };
    showSection("auth");
    $("app").style.display = "none";
    $("authScreen").style.display = "block";
  }
  if(sess){ session = sess; }
  if(sess) session = sess;
});

// ---------- Section toggles ----------
function showSection(which){
  $("auth").style.display = which==="auth" ? "flex" : "none";
  $("usernameSetup").style.display = which==="username" ? "flex" : "none";
  $("app").style.display = which==="app" ? "grid" : "none";
}

// ---------- Login ----------
// login button
$("loginBtn").onclick = async ()=>{
  const email = $("loginEmail").value.trim();
  const password = $("loginPassword").value.trim();
  if(!email || !password) return alert("Enter email and password");

  const { data, error } = await client.auth.signInWithPassword({ email, password });
  if(error) return alert(error.message);

  await afterLogin(data.user);
};

async function afterLogin(user){
  me.email = user.email;

  // fetch username
  // lookup username by email
  const { data: row, error } = await client.from("users").select("username").eq("email", me.email).maybeSingle();
  if(error){ console.error(error); }

  if(error) console.error(error);
  if(!row || !row.username){
    showSection("username");
  } else {
    me.username = row.username;
    initApp();
    // prompt username
    $("authScreen").style.display = "none";
    $("usernameScreen").style.display = "block";
    return;
  }
  me.username = row.username;
  startApp();
}

// ---------- Username creation ----------
// save username
$("saveUsernameBtn").onclick = async ()=>{
  const u = $("usernameInput").value.trim();
  if(!/^[a-zA-Z0-9_]{1,15}$/.test(u)) return alert("Use letters/numbers/underscore only, max 15.");
  // ensure unique
  const { data: exists } = await client.from("users").select("username").eq("username", u).maybeSingle();
  if(exists) return alert("That username is taken.");

  // upsert so repeat presses don't error
  const { error } = await client.from("users").upsert({ email: me.email, username: u }, { onConflict: "email" });
  // uniqueness check
  const { data: exist } = await client.from("users").select("email").eq("username", u).maybeSingle();
  if(exist) return alert("Username taken");
  const { error } = await client.from("users").upsert({ email: me.email, username: u }, { onConflict:"email" });
  if(error) return alert(error.message);

  me.username = u;
  initApp();
  $("usernameScreen").style.display = "none";
  startApp();
};

// ---------- App init ----------
function initApp(){
  $("meInfo").textContent = `${me.username} (${me.email})`;
  showSection("app");
  setRoomHeader("Global Chat", "GC");

  // load lists and messages
// start app UI
function startApp(){
  $("meInfo").textContent = `${me.username} â€” ${me.email}`;
  $("authScreen").style.display = "none";
  $("usernameScreen").style.display = "none";
  $("app").style.display = "grid";
  setRoomHeader("Global Chat","GC");
  loadFriends();
  loadRequests();
  loadGlobalMessages();
  subscribeGlobal();
  // composer wiring
  wireComposer();
  // search
  $("searchBox").addEventListener("input", debounce(searchUsers, 300));
}

// ---------- Room header ----------
// header helper
function setRoomHeader(title, initialsTxt){
  $("roomTitle").textContent = title;
  $("roomAvatar").textContent = initialsTxt;
}

// ---------- Composer (Enter to send on desktop; button for mobile) ----------
// composer wiring (reliable Enter handler)
function wireComposer(){
  const send = async ()=> {
    const txt = $("composerInput").value.trim();
    if(!txt) return;

    if(currentView.type === "global"){
      const { error } = await client.from("messages").insert({
        username: me.username, message: txt, sender_email: me.email
      });
      const { error } = await client.from("messages").insert({ username: me.username, message: txt, sender_email: me.email });
      if(!error) $("composerInput").value = "";
    } else {
      const { error } = await client.from("dm_messages").insert({
        sender_email: me.email, receiver_email: currentView.peerEmail, content: txt
      });
      const { error } = await client.from("dm_messages").insert({ sender_email: me.email, receiver_email: currentView.peerEmail, content: txt });
      if(!error) $("composerInput").value = "";
    }
  };

  $("composerInput").addEventListener("keydown",(e)=>{
    // Desktop: Enter sends; Shift+Enter for newline if you ever switch to textarea
  // keydown: Enter = send (desktop). Shift+Enter newline.
  $("composerInput").addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !isMobile()){
      e.preventDefault(); send();
      if(e.shiftKey) return; // allow newline if desired in future textarea
      e.preventDefault();
      send();
    }
  });
  $("sendBtn").onclick = send; // mobile visible
  // mobile send button
  $("sendBtn").onclick = ()=> {
    if(isMobile()) $("composerInput").focus(); // mobile: focus input first for keyboard
    // send whether mobile or not â€” mobile users can tap Send
    const ev = new Event('sendManual');
    $("composerInput").dispatchEvent(ev);
  };
  // also handle manual send event
  $("composerInput").addEventListener("sendManual", send);
}

// ---------- Global chat ----------
// GLOBAL messages
async function loadGlobalMessages(){
  const { data, error } = await client.from("messages").select("*").order("created_at",{ascending:true});
  if(error) return console.error(error);
  const box = $("messages"); box.innerHTML = "";
  data.forEach(m=>appendBubble(box, m.username, m.sender_email === me.email, m.message));
  data.forEach(m => appendBubble(box, m.username, m.sender_email === me.email, m.message));
}

function subscribeGlobal(){
  client.channel("global-feed")
    .on("postgres_changes", { event:"INSERT", schema:"public", table:"messages" }, payload=>{
      if(currentView.type === "global"){
        appendBubble($("messages"), payload.new.username, payload.new.sender_email === me.email, payload.new.message);
      }
    })
    .subscribe();
      if(currentView.type === "global") appendBubble($("messages"), payload.new.username, payload.new.sender_email === me.email, payload.new.message);
    }).subscribe();
}

// ---------- DMs ----------
// DMs open/toggle
async function openDM(peerEmail, peerUsername){
  if(currentView.type === "dm" && currentView.peerEmail === peerEmail){
    // toggle back to global
@@ -390,114 +271,68 @@ <h2 style="color:var(--accent-2)">Create your username</h2>
    await loadGlobalMessages();
    return;
  }

  currentView = { type:"dm", peerEmail, peerUsername };
  setRoomHeader(peerUsername, initials(peerUsername));

  const { data, error } = await client
    .from("dm_messages")
  // load DM history
  const { data, error } = await client.from("dm_messages")
    .select("*")
    .or(`and(sender_email.eq.${me.email},receiver_email.eq.${peerEmail}),and(sender_email.eq.${peerEmail},receiver_email.eq.${me.email})`)
    .order("created_at",{ascending:true});

  if(error){ console.error(error); return; }

  if(error) return console.error(error);
  const box = $("messages"); box.innerHTML = "";
  data.forEach(m=>{
    const mine = m.sender_email === me.email;
    appendBubble(box, mine? me.username : peerUsername, mine, m.content);
  });

  // realtime for DM
  data.forEach(m => appendBubble(box, (m.sender_email === me.email? me.username: peerUsername), m.sender_email === me.email, m.content));
  // subscribe DM channel
  subscribeDM(peerEmail, peerUsername);
}

let dmChannel = null;
function subscribeDM(peerEmail, peerUsername){
  if(dmChannel) client.removeChannel(dmChannel);
  dmChannel = client.channel(`dm-${me.email}-${peerEmail}`)
    .on("postgres_changes",
      { event:"INSERT", schema:"public", table:"dm_messages" },
      (payload)=>{
        const m = payload.new;
        const involved = (m.sender_email===me.email && m.receiver_email===peerEmail) ||
                         (m.sender_email===peerEmail && m.receiver_email===me.email);
        if(currentView.type==="dm" && involved){
          const mine = m.sender_email === me.email;
          appendBubble($("messages"), mine? me.username : peerUsername, mine, m.content);
        }
      })
    .subscribe();
    .on("postgres_changes", { event:"INSERT", schema:"public", table:"dm_messages" }, payload=>{
      const m = payload.new;
      const involved = (m.sender_email===me.email && m.receiver_email===peerEmail) || (m.sender_email===peerEmail && m.receiver_email===me.email);
      if(currentView.type==="dm" && involved){
        appendBubble($("messages"), (m.sender_email===me.email? me.username : peerUsername), m.sender_email===me.email, m.content);
      }
    }).subscribe();
}

// ---------- Friend search / requests / list ----------
// friends: search, requests, list
async function searchUsers(){
  const q = $("searchBox").value.trim();
  const box = $("searchResults");
  if(!q){ box.innerHTML=""; return; }
  const { data, error } = await client.from("users")
    .select("email, username")
    .ilike("username", `%${q}%`)
    .limit(20);
  if(error){ console.error(error); return; }

  box.innerHTML = "";
  data
    .filter(u=>u.email!==me.email)
    .forEach(u=>{
      const item = document.createElement("div");
      item.className = "list-item";
      item.innerHTML = `
        <div class="avatar">${initials(u.username)}</div>
        <div class="meta"><div class="name">${u.username}</div><div class="muted">${u.email}</div></div>
        <div style="margin-left:auto" class="row">
          <button class="btn primary">Add</button>
        </div>`;
      item.querySelector("button").onclick = ()=> sendFriendRequest(u.email);
      box.appendChild(item);
    });
  const box = $("searchResults"); box.innerHTML = "";
  if(!q) return;
  const { data, error } = await client.from("users").select("email,username").ilike("username", `%${q}%`).limit(20);
  if(error) return console.error(error);
  data.filter(u=>u.email !== me.email).forEach(u=>{
    const el = document.createElement("div"); el.className="list-item";
    el.innerHTML = `<div class="avatar">${initials(u.username)}</div><div class="meta"><div class="name">${u.username}</div><div class="muted">${u.email}</div></div><div style="margin-left:auto" class="row"><button class="btn primary">Add</button></div>`;
    el.querySelector("button").onclick = ()=> sendFriendRequest(u.email);
    box.appendChild(el);
  });
}

async function sendFriendRequest(toEmail){
  // prevent duplicates both directions
  // check duplicate both ways
  const { data: existing } = await client.from("friends")
    .select("id,status")
    .or(`and(requester_email.eq.${me.email},addressee_email.eq.${toEmail}),and(requester_email.eq.${toEmail},addressee_email.eq.${me.email})`)
    .maybeSingle();

  if(existing){
    alert(`Already ${existing.status}`);
    return;
  }

  const { error } = await client.from("friends").insert({
    requester_email: me.email, addressee_email: toEmail, status: "pending"
  });
  if(error) alert(error.message); else alert("Request sent!");
  if(existing) return alert(`Already ${existing.status}`);
  const { error } = await client.from("friends").insert({ requester_email: me.email, addressee_email: toEmail, status: "pending" });
  if(error) return alert(error.message);
  alert("Request sent");
  loadRequests();
}

async function loadRequests(){
  const box = $("requests"); box.innerHTML = "";
  const { data, error } = await client.from("friends")
    .select("id, requester_email")
    .eq("addressee_email", me.email)
    .eq("status","pending")
    .order("created_at",{ascending:false});
  const { data, error } = await client.from("friends").select("id,requester_email").eq("addressee_email", me.email).eq("status","pending").order("created_at",{ascending:false});
  if(error) return console.error(error);

  // fetch usernames for requesters
  for(const r of data){
    const { data: u } = await client.from("users").select("username").eq("email", r.requester_email).maybeSingle();
    const name = u?.username || r.requester_email;
    const row = document.createElement("div");
    row.className = "list-item";
    row.innerHTML = `
      <div class="avatar">${initials(name)}</div>
      <div class="meta"><div class="name">${name}</div><div class="muted">wants to add you</div></div>
      <div style="margin-left:auto" class="row">
        <button class="btn success">Accept</button>
        <button class="btn danger">Decline</button>
      </div>`;
    const row = document.createElement("div"); row.className="list-item";
    row.innerHTML = `<div class="avatar">${initials(name)}</div><div class="meta"><div class="name">${name}</div><div class="muted">wants to add you</div></div><div style="margin-left:auto" class="row"><button class="btn success">Accept</button><button class="btn danger">Decline</button></div>`;
    row.querySelector(".success").onclick = ()=> respondRequest(r.id,"accepted");
    row.querySelector(".danger").onclick = ()=> respondRequest(r.id,"declined");
    box.appendChild(row);
@@ -507,61 +342,49 @@ <h2 style="color:var(--accent-2)">Create your username</h2>
async function respondRequest(id, status){
  const { error } = await client.from("friends").update({ status }).eq("id", id);
  if(error) return alert(error.message);
  await loadRequests();
  await loadFriends();
  loadRequests();
  loadFriends();
}

async function loadFriends(){
  const box = $("friends"); box.innerHTML = "";

  // accepted where I'm requester
  const { data: a } = await client.from("friends")
    .select("requester_email, addressee_email, status")
    .or(`requester_email.eq.${me.email},addressee_email.eq.${me.email}`)
    .eq("status","accepted");

  // accepted either side
  const { data } = await client.from("friends").select("requester_email,addressee_email,status").or(`requester_email.eq.${me.email},addressee_email.eq.${me.email}`).eq("status","accepted");
  const peerEmails = new Set();
  (a||[]).forEach(r=>{
    const peer = r.requester_email===me.email ? r.addressee_email : r.requester_email;
  (data||[]).forEach(r => {
    const peer = r.requester_email === me.email ? r.addressee_email : r.requester_email;
    peerEmails.add(peer);
  });

  for(const email of peerEmails){
    const { data: u } = await client.from("users").select("username").eq("email", email).maybeSingle();
    const name = u?.username || email;
    const item = document.createElement("div");
    item.className = "list-item";
    item.innerHTML = `
      <div class="avatar">${initials(name)}</div>
      <div class="meta"><div class="name">${name}</div><div class="muted">${email}</div></div>`;
    const item = document.createElement("div"); item.className="list-item";
    item.innerHTML = `<div class="avatar">${initials(name)}</div><div class="meta"><div class="name">${name}</div><div class="muted">${email}</div></div>`;
    item.onclick = ()=> openDM(email, name);
    box.appendChild(item);
  }
}

// ---------- Message rendering ----------
// rendering bubbles
function appendBubble(container, fromName, mine, text){
  const wrap = document.createElement("div");
  wrap.className = `bubble ${mine? "me":"them"}`;
  wrap.innerHTML = `
    <div class="from">
      <div class="avatar" style="width:26px;height:26px;font-size:.75rem;">${initials(fromName)}</div>
      <div>${fromName}</div>
    </div>
    <div>${escapeHtml(text)}</div>
  `;
  wrap.innerHTML = `<div class="from"><div class="avatar" style="width:26px;height:26px;font-size:.75rem">${initials(fromName)}</div><div>${fromName}</div></div><div>${escapeHtml(text)}</div>`;
  container.appendChild(wrap);
  container.scrollTop = container.scrollHeight;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

function escapeHtml(s){
  return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
}
// utilities
function debounce(fn,ms){ let t; return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)} }

// ---------- Utilities ----------
function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
// small boot helpers to load global data
async function loadGlobalMessages(){ const { data, error } = await client.from("messages").select("*").order("created_at",{ascending:true}); if(error) return console.error(error); $("messages").innerHTML = ""; data.forEach(m=>appendBubble($("messages"), m.username, m.sender_email===me.email, m.message)); }

// export for debugging (optional)
window._texter = { client, me };

// End of script
</script>
</body>
</html>
