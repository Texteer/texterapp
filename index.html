<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const supabaseUrl = 'https://azpgwbxillscpwrraprl.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cGd3YnhpbGxzY3B3cnJhcHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg1MjQsImV4cCI6MjA3MjYzNDUyNH0.h7ZDxtH4pB3K5IzRB9goLJ1ldrY6EGf7CWT-ELGQ0i0'; // ⚠️ replace with your anon key
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const codeInput = document.getElementById('codeInput');
  const loginBtn = document.getElementById('loginBtn');
  const authModal = document.getElementById('authModal');
  const userListEl = document.getElementById('userList');
  const chatHeader = document.getElementById('chatHeader');
  const typingIndicator = document.getElementById('typingIndicator');

  let currentUser = null;
  let currentChat = { type: "global", target: null };
  let typingTimeout = null;

  function getInitials(name) { return name.split(' ').map(n=>n[0].toUpperCase()).join('').slice(0,2); }
  function stringToColor(str){let hash=0;for(let i=0;i<str.length;i++){hash=str.charCodeAt(i)+((hash<<5)-hash);}return `hsl(${hash%360},70%,50%)`; }
  function createProfileCircle(username){const span=document.createElement('span');span.className='profileCircle';span.style.background=stringToColor(username);span.textContent=getInitials(username);return span;}

  function appendMessage(message, type){
    const div=document.createElement('div');div.className='message '+type;
    div.appendChild(createProfileCircle(message.username));
    const content=document.createElement('div');
    content.innerHTML=`<strong>${message.username}</strong>: ${message.message} <span class="timestamp">${new Date(message.created_at).toLocaleTimeString()}</span>`;
    div.appendChild(content);messagesEl.appendChild(div);div.scrollIntoView();
  }

  async function loginWithCode(code){
    const { data, error } = await supabaseClient.from('chat_codes').select('username').eq('code', code).single();
    if(error || !data){alert('Invalid code'); return;}
    currentUser={ username:data.username, code }; localStorage.setItem('chatCode', code); authModal.style.display='none';

    await supabaseClient.from('online_users').upsert({ username:currentUser.username,last_seen:new Date().toISOString() });
    loadUsers(); loadMessages(); subscribeMessages(); subscribeTyping(); subscribePresence();
  }

  loginBtn.onclick=()=>{const code=codeInput.value.trim();if(!code)return alert('Enter code'); loginWithCode(code);}
  const savedCode=localStorage.getItem('chatCode'); if(savedCode) loginWithCode(savedCode);

  async function sendMessage(){
    if(!messageInput.value||!currentUser)return;
    const content=messageInput.value; messageInput.value='';
    if(currentChat.type==='global'){
      const newMessage={ username:currentUser.username, message:content, created_at:new Date().toISOString() };
      appendMessage(newMessage,'self');
      await supabaseClient.from('global_messages').insert([newMessage]);
    }else{
      const newMessage={ sender:currentUser.username, receiver:currentChat.target, message:content, created_at:new Date().toISOString() };
      appendMessage({username:currentUser.username,message:content,created_at:new Date().toISOString()},'self');
      await supabaseClient.from('private_messages').insert([newMessage]);
    }
  }

  sendBtn.onclick=sendMessage;
  messageInput.addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage();});

  async function loadMessages(){
    messagesEl.innerHTML='';
    if(currentChat.type==='global'){
      chatHeader.textContent="Global Chat";
      const { data } = await supabaseClient.from('global_messages').select('*').order('created_at',{ascending:true});
      data.forEach(m=>{appendMessage(m,(m.username===currentUser.username)?'self':'other');});
    }else{
      chatHeader.textContent=`Chat with ${currentChat.target}`;
      const { data } = await supabaseClient.from('private_messages')
        .select('*')
        .or(`and(sender.eq.${currentUser.username},receiver.eq.${currentChat.target}),and(sender.eq.${currentChat.target},receiver.eq.${currentUser.username})`)
        .order('created_at',{ascending:true});
      data.forEach(m=>appendMessage({username:m.sender,message:m.message,created_at:m.created_at},(m.sender===currentUser.username)?'self':'other'));
    }
  }

  async function loadUsers(){
    const { data: allUsers } = await supabaseClient.from('users').select('username');
    const { data: online } = await supabaseClient.from('online_users').select('username');
    const onlineSet=new Set(online.map(u=>u.username));
    userListEl.innerHTML='';
    allUsers.forEach(u=>{
      const item=document.createElement('div'); item.className='userItem';
      const circle=createProfileCircle(u.username); const nameEl=document.createElement('span'); nameEl.className='username'; nameEl.textContent=u.username;
      const dot=document.createElement('span'); dot.className='dot'; dot.style.background=onlineSet.has(u.username)?'#0f0':'#555';
      item.appendChild(circle); item.appendChild(nameEl); item.appendChild(dot);
      
      // 👇 toggle DM when clicked
      item.onclick=()=>{
        if(currentChat.type==='private' && currentChat.target===u.username){
          currentChat={ type:'global', target:null };
        }else if(u.username!==currentUser.username){
          currentChat={ type:'private', target:u.username };
        }
        loadMessages();
      };
      
      userListEl.appendChild(item);
    });
  }

  function subscribeMessages(){
    supabaseClient.channel('messages')
      .on('postgres_changes',{ event:'INSERT', schema:'public', table:'global_messages' },payload=>{
        const m=payload.new; if(currentChat.type==='global' && m.username!==currentUser.username)appendMessage(m,'other');
      }).subscribe();

    supabaseClient.channel('privates')
      .on('postgres_changes',{ event:'INSERT', schema:'public', table:'private_messages' },payload=>{
        const m=payload.new;
        if((m.sender===currentChat.target && m.receiver===currentUser.username) || (m.receiver===currentChat.target && m.sender===currentUser.username)){
          if(currentChat.type==='private') appendMessage({username:m.sender,message:m.message,created_at:m.created_at},(m.sender===currentUser.username)?'self':'other');
        }
      }).subscribe();
  }

  function subscribeTyping(){
    supabaseClient.channel('typing')
      .on('postgres_changes',{ event:'UPDATE', schema:'public', table:'typing_status' },payload=>{
        const t=payload.new;
        if(t.username!==currentUser.username){
          typingIndicator.textContent=t.typing?`${t.username} is typing...`:'';
        }
      }).subscribe();
  }

  async function subscribePresence(){
    setInterval(async()=>{
      await supabaseClient.from('online_users').upsert({username:currentUser.username,last_seen:new Date().toISOString()});
      loadUsers();
    },5000);
  }

  messageInput.addEventListener('input',async()=>{
    await supabaseClient.from('typing_status').upsert({username:currentUser.username,typing:true,updated_at:new Date().toISOString()});
    clearTimeout(typingTimeout); typingTimeout=setTimeout(async()=>{await supabaseClient.from('typing_status').upsert({username:currentUser.username,typing:false,updated_at:new Date().toISOString()})},2000);
  });

});
</script>

