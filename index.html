<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Supabase Chat</title>
<style>
  /* Your CSS styles (unchanged from your original code) */
  body {
    font-family: Arial, sans-serif;
    background: #0d1117;
    color: #f0f6fc;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  #app {
    width: 90%;
    max-width: 600px;
    background: #161b22;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
  }
  h2 {
    text-align: center;
    color: #58a6ff;
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    border: none;
    box-sizing: border-box;
  }
  input {
    background: #0d1117;
    color: #f0f6fc;
    border: 1px solid #30363d;
  }
  button {
    background: #238636;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background: #2ea043;
  }
  #messages {
    border: 1px solid #30363d;
    height: 300px;
    overflow-y: auto;
    background: #0d1117;
    padding: 10px;
    margin: 10px 0;
    border-radius: 5px;
  }
  /* Additional styles omitted for brevity, keep your existing layout styles here */
</style>
</head>
<body>
<div id="app">
<h2>Supabase Chat</h2>

<!-- Login Page -->
<div id="login">
  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email" />
  <input type="password" id="loginPassword" placeholder="Password" />
  <button id="loginBtn">Login</button>
</div>

<!-- Username Setup -->
<div id="set-username" style="display:none;">
  <h3>Create Your Username</h3>
  <input type="text" id="newUsername" placeholder="Choose a username (max 15 chars, no symbols)" />
  <button id="saveUsernameBtn">Save Username</button>
</div>

<!-- Main App -->
<div id="main-app" style="display:none;">
  <header>
    <div class="brand">Texter</div>
    <div class="me" id="meInfo">Signed in as —</div>
  </header>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="section-title">Find friends</div>
    <div class="search">
      <input id="searchBox" type="text" placeholder="Search username…" />
    </div>
    <div class="results" id="searchResults"></div>

    <div class="section-title">Requests</div>
    <div class="results" id="requests"></div>

    <div class="section-title">Friends</div>
    <div class="friends" id="friends"></div>
  </aside>

  <!-- Chat section -->
  <section class="chat">
    <div class="chat-header">
      <div class="avatar" id="roomAvatar">GC</div>
      <div class="chat-title" id="roomTitle">Global Chat</div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="composer">
      <input id="composerInput" type="text" placeholder="Type a message… (Enter to send)" />
      <button id="sendBtn" class="btn primary send-mobile">Send</button>
    </div>
  </section>
</div>
</div>

<!-- Include Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<script>
  // Initialize Supabase client first
  const supabaseUrl = "https://fhokwoazuhkwrkrweddd.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // State variables
  let currentUser = null;
  let currentUsername = null;

  // Utility functions
  const $ = (id) => document.getElementById(id);
  const showSection = (id) => {
    document.querySelectorAll('#login, #set-username, #main-app').forEach(el => el.style.display = 'none');
    $(id).style.display = 'block';
  };
  const initials = (name='?') => {
    const parts = name.trim().split(/[\s_]+/);
    const a = (parts[0]||'')[0]||'?';
    const b = (parts[1]||'')[0]||'';
    return (a + b).toUpperCase();
  };

  // Load session on startup
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session && session.user) {
      await afterLogin(session.user);
    } else {
      showSection('login');
    }
  })();

  // Login button click handler
  document.getElementById('loginBtn').onclick = async () => {
    const email = $('#loginEmail').value.trim();
    const password = $('#loginPassword').value.trim();
    if (!email || !password) {
      alert('Please enter email and password.');
      return;
    }
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      alert('Login failed: ' + error.message);
    } else {
      await afterLogin(data.user);
    }
  };

  // Monitor auth state changes
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_OUT') {
      currentUser = null;
      currentUsername = null;
      showSection('login');
    } else if (session && session.user) {
      await afterLogin(session.user);
    }
  });

  // After login function
  async function afterLogin(user) {
    currentUser = user;
    // Check if username exists
    const { data: userRecord, error } = await supabase
      .from('users')
      .select('username')
      .eq('email', user.email)
      .maybeSingle();

    if (error) {
      console.error('Error fetching user:', error);
    }

    if (userRecord && userRecord.username) {
      currentUsername = userRecord.username;
      initApp();
    } else {
      showSection('set-username');
    }
  }

  // Save username handler
  document.getElementById('saveUsernameBtn').onclick = async () => {
    const usernameInput = $('#newUsername').value.trim();
    if (!/^[a-zA-Z0-9_]{1,15}$/.test(usernameInput)) {
      alert('Use letters/numbers/underscore only, max 15.');
      return;
    }
    // Check for duplicate username
    const { data: exists } = await supabase
      .from('users')
      .select('username')
      .eq('username', usernameInput)
      .maybeSingle();
    if (exists) {
      alert('That username is taken.');
      return;
    }
    // Insert or update user record
    const { error } = await supabase
      .from('users')
      .upsert({ email: currentUser.email, username: usernameInput }, { onConflict: 'email' });
    if (error) {
      alert('Error saving username: ' + error.message);
      return;
    }
    currentUsername = usernameInput;
    initApp();
  };

  // Initialize main app after login / username setup
  async function initApp() {
    showSection('main-app');
    $('#meInfo').textContent = `${currentUsername} (${currentUser.email})`;
    setRoomHeader('Global Chat', 'GC');
    loadFriends();
    loadRequests();
    loadGlobalMessages();
    subscribeGlobal();

    // Setup message send on Enter key
    $('#composerInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !isMobile()) {
        e.preventDefault();
        sendMessage();
      }
    });
    $('#sendBtn').onclick = sendMessage;
  }

  // Helper for mobile detection
  const isMobile = () => matchMedia('(max-width: 900px)').matches || 'ontouchstart' in window;

  // Set chat room header
  function setRoomHeader(title, initialsTxt) {
    $('#roomTitle').textContent = title;
    $('#roomAvatar').textContent = initialsTxt;
  }

  // Send message function
  async function sendMessage() {
    const message = $('#composerInput').value.trim();
    if (!message || !currentUser || !currentUsername) return;

    if (currentView?.type === 'global') {
      const { error } = await supabase
        .from('messages')
        .insert({ username: currentUsername, message, sender_email: currentUser.email });
      if (!error) $('#composerInput').value = '';
    } else if (currentView?.type === 'dm') {
      const { error } = await supabase
        .from('dm_messages')
        .insert({
          sender_email: currentUser.email,
          receiver_email: currentView.peerEmail,
          content: message
        });
      if (!error) $('#composerInput').value = '';
    }
  }

  // Load global messages
  async function loadGlobalMessages() {
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .order('created_at', { ascending: true });
    if (error) {
      console.error(error);
      return;
    }
    const msgDiv = $('#messages');
    msgDiv.innerHTML = '';
    data.forEach(m => appendBubble(msgDiv, m.username, m.sender_email === currentUser.email, m.message));
  }

  // Subscribe to new messages in global chat
  function subscribeGlobal() {
    supabase
      .channel('global-feed')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
        if (currentView?.type === 'global') {
          appendBubble($('#messages'), payload.new.username, payload.new.sender_email === currentUser.email, payload.new.message);
        }
      })
      .subscribe();
  }

  // Open DM chat
  async function openDM(peerEmail, peerUsername) {
    if (currentView?.type === 'dm' && currentView.peerEmail === peerEmail) {
      // toggle back to global
      currentView = { type: 'global', peerEmail: null, peerUsername: null };
      setRoomHeader('Global Chat', 'GC');
      $('#messages').innerHTML = '';
      await loadGlobalMessages();
      return;
    }

    currentView = { type: 'dm', peerEmail, peerUsername };
    setRoomHeader(peerUsername, initials(peerUsername));

    const { data, error } = await supabase
      .from('dm_messages')
      .select('*')
      .or(`and(sender_email.eq.${currentUser.email},receiver_email.eq.${peerEmail}),and(sender_email.eq.${peerEmail},receiver_email.eq.${currentUser.email})`)
      .order('created_at', { ascending: true });
    if (error) {
      console.error(error);
      return;
    }

    const box = $('#messages');
    box.innerHTML = '';
    data.forEach(m => {
      const mine = m.sender_email === currentUser.email;
      appendBubble(box, mine ? currentUsername : peerUsername, mine, m.content);
    });
    subscribeDM(peerEmail, peerUsername);
  }

  let dmChannel = null;
  function subscribeDM(peerEmail, peerUsername) {
    if (dmChannel) supabase.removeChannel(dmChannel);
    dmChannel = supabase
      .channel(`dm-${currentUser.email}-${peerEmail}`)
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'dm_messages' }, (payload) => {
        const m = payload.new;
        const involved = (m.sender_email === currentUser.email && m.receiver_email === peerEmail) ||
                         (m.sender_email === peerEmail && m.receiver_email === currentUser.email);
        if (currentView?.type === 'dm' && involved) {
          const mine = m.sender_email === currentUser.email;
          appendBubble($('#messages'), mine ? currentUsername : peerUsername, mine, m.content);
        }
      });
    supabase.subscribe(dmChannel);
  }

  // Search users
  async function searchUsers() {
    const q = $('#searchBox').value.trim();
    const box = $('#searchResults');
    if (!q) {
      box.innerHTML = '';
      return;
    }
    const { data, error } = await supabase
      .from('users')
      .select('email, username')
      .ilike('username', `%${q}%`)
      .limit(20);
    if (error) {
      console.error(error);
      return;
    }
    box.innerHTML = '';
    data
      .filter(u => u.email !== currentUser.email)
      .forEach(u => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
          <div class="avatar">${initials(u.username)}</div>
          <div class="meta"><div class="name">${u.username}</div><div class="muted">${u.email}</div></div>
          <div style="margin-left:auto" class="row">
            <button class="btn primary">Add</button>
          </div>`;
        item.querySelector('button').onclick = () => sendFriendRequest(u.email);
        $('#searchResults').appendChild(item);
      });
  }

  async function sendFriendRequest(toEmail) {
    // prevent duplicates
    const { data: existing } = await supabase
      .from('friends')
      .select('id, status')
      .or(`and(requester_email.eq.${currentUser.email},addressee_email.eq.${toEmail}),and(requester_email.eq.${toEmail},addressee_email.eq.${currentUser.email})`)
      .maybeSingle();
    if (existing) {
      alert(`Already ${existing.status}`);
      return;
    }

    const { error } = await supabase
      .from('friends')
      .insert({ requester_email: currentUser.email, addressee_email: toEmail, status: 'pending' });
    if (error) alert(error.message);
    else alert('Request sent!');
  }

  async function loadRequests() {
    $('#requests').innerHTML = '';
    const { data, error } = await supabase
      .from('friends')
      .select('id, requester_email')
      .eq('addressee_email', currentUser.email)
      .eq('status', 'pending')
      .order('created_at', { ascending: false });
    if (error) {
      console.error(error);
      return;
    }
    for (const r of data) {
      const { data: u } = await supabase
        .from('users')
        .select('username')
        .eq('email', r.requester_email)
        .maybeSingle();
      const name = u?.username || r.requester_email;
      const row = document.createElement('div');
      row.className = 'list-item';
      row.innerHTML = `
        <div class="avatar">${initials(name)}</div>
        <div class="meta"><div class="name">${name}</div><div class="muted">wants to add you</div></div>
        <div style="margin-left:auto" class="row">
          <button class="btn success">Accept</button>
          <button class="btn danger">Decline</button>
        </div>`;
      row.querySelector('.success').onclick = () => respondRequest(r.id, 'accepted');
      row.querySelector('.danger').onclick = () => respondRequest(r.id, 'declined');
      $('#requests').appendChild(row);
    }
  }

  async function respondRequest(id, status) {
    const { error } = await supabase.from('friends').update({ status }).eq('id', id);
    if (error) {
      alert(error.message);
      return;
    }
    await loadRequests();
    await loadFriends();
  }

  async function loadFriends() {
    $('#friends').innerHTML = '';

    const { data } = await supabase
      .from('friends')
      .select('requester_email, addressee_email, status')
      .or(`requester_email.eq.${currentUser.email},addressee_email.eq.${currentUser.email}`)
      .eq('status', 'accepted');

    const peerEmails = new Set();
    (data || []).forEach(r => {
      const peer = r.requester_email === currentUser.email ? r.addressee_email : r.requester_email;
      peerEmails.add(peer);
    });

    for (const email of peerEmails) {
      const { data: u } = await supabase
        .from('users')
        .select('username')
        .eq('email', email)
        .maybeSingle();
      const name = u?.username || email;
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <div class="avatar">${initials(name)}</div>
        <div class="meta"><div class="name">${name}</div><div class="muted">${email}</div></div>`;
      item.onclick = () => openDM(email, name);
      $('#friends').appendChild(item);
    }
  }

  // Append message bubble
  function appendBubble(container, fromName, mine, text) {
    const wrap = document.createElement('div');
    wrap.className = `bubble ${mine ? 'me' : 'them'}`;
    wrap.innerHTML = `
      <div class="from">
        <div class="avatar" style="width:26px;height:26px;font-size:.75rem;">${initials(fromName)}</div>
        <div>${fromName}</div>
      </div>
      <div>${escapeHtml(text)}</div>
    `;
    container.appendChild(wrap);
    container.scrollTop = container.scrollHeight;
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch]));
  }

</script>
</body>
</html>
