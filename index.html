<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realtime Chat App</title>
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; background:#0a0f1a; color:#fff; display:flex; height:100vh; }
#sidebar { width:250px; background:#101426; display:flex; flex-direction:column; border-right:1px solid #1c2335; }
#sidebar h2 { padding:1rem; margin:0; border-bottom:1px solid #1c2335; }
#channels { flex:1; overflow-y:auto; }
.channel { display:flex; align-items:center; padding:0.5rem 1rem; cursor:pointer; border-bottom:1px solid #1c2335; }
.channel:hover { background:#141a2c; }
.profile-circle { width:32px; height:32px; border-radius:50%; background:#0b78e3; display:flex; align-items:center; justify-content:center; margin-right:0.5rem; font-weight:bold; }
#main { flex:1; display:flex; flex-direction:column; }
#messages { flex:1; padding:1rem; overflow-y:auto; display:flex; flex-direction:column; gap:0.3rem; }
.message { padding:0.6rem 1rem; border-radius:15px; max-width:65%; word-break:break-word; }
.message.self { background:#0b78e3; align-self:flex-end; color:#fff; }
.message.other { background:#1c2335; align-self:flex-start; color:#fff; }
.timestamp { font-size:0.65rem; color:#7a7a7a; margin-left:0.5rem; }
#typingIndicator { font-size:0.75rem; color:#7a7a7a; padding:0 1rem; height:20px; }
#input { display:flex; padding:0.5rem; background:#101426; border-top:1px solid #1c2335; }
#input input { flex:1; padding:0.6rem 1rem; border-radius:20px 0 0 20px; border:none; background:#141a2c; color:#fff; }
#input button { padding:0.6rem 1.2rem; border:none; border-radius:0 20px 20px 0; background:#0b78e3; color:#fff; cursor:pointer; font-weight:bold; }
#authModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:10; }
#authBox { background:#101426; padding:2rem; border-radius:15px; width:320px; display:flex; flex-direction:column; box-shadow:0 5px 20px rgba(0,0,0,0.5);}
#authBox input { margin-bottom:1rem; padding:0.6rem; border-radius:8px; border:none; background:#141a2c; color:#fff; }
#authBox button { padding:0.6rem; border:none; border-radius:8px; background:#0b78e3; color:#fff; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Channels</h2>
  <div id="channels"></div>
</div>

<div id="main">
  <div id="messages"></div>
  <div id="typingIndicator"></div>
  <div id="input">
    <input type="text" id="messageInput" placeholder="Type your message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<div id="authModal">
  <div id="authBox">
    <h2>Enter Code</h2>
    <input type="text" id="codeInput" placeholder="Enter your code">
    <button id="loginBtn">Enter Chat</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://azpgwbxillscpwrraprl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cGd3YnhpbGxzY3B3cnJhcHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg1MjQsImV4cCI6MjA3MjYzNDUyNH0.h7ZDxtH4pB3K5IzRB9goLJ1ldrY6EGf7CWT-ELGQ0i0';
const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

document.addEventListener('DOMContentLoaded', () => {
  let currentUser = null;
  let currentChannel = 'global';
  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const typingIndicator = document.getElementById('typingIndicator');
  const channelsEl = document.getElementById('channels');
  const authModal = document.getElementById('authModal');
  const codeInput = document.getElementById('codeInput');
  const loginBtn = document.getElementById('loginBtn');

  function appendMessage(msg,type){
    const div = document.createElement('div');
    div.className = 'message '+type;
    div.innerHTML = `<strong>${msg.username||msg.sender}</strong>: ${msg.message} <span class="timestamp">${new Date(msg.created_at).toLocaleTimeString()}</span>`;
    messagesEl.appendChild(div);
    div.scrollIntoView();
  }

  async function loginWithCode(code){
    const { data, error } = await supabase.from('chat_codes').select('username').eq('code', code).single();
    if(error || !data){ alert('Invalid code'); return false; }
    currentUser = { username: data.username, code };
    localStorage.setItem('chatCode', code);
    authModal.style.display='none';
    await loadSidebar();
    loadMessages();
    subscribeMessages();
    subscribeTyping();
    return true;
  }

  const savedCode = localStorage.getItem('chatCode');
  if(savedCode) loginWithCode(savedCode);

  loginBtn.onclick = ()=>{
    const code = codeInput.value.trim();
    if(!code) return alert('Enter your code');
    loginWithCode(code);
  };

  async function loadSidebar(){
    channelsEl.innerHTML='';
    // Global
    const globalDiv = document.createElement('div');
    globalDiv.className='channel';
    globalDiv.innerHTML='<div class="profile-circle">G</div>Global Chat';
    globalDiv.onclick=()=>{ currentChannel='global'; loadMessages(); }
    channelsEl.appendChild(globalDiv);
    // Users
    const { data: users } = await supabase.from('chat_codes').select('*');
    users.forEach(user=>{
      if(user.username===currentUser.username) return;
      const div = document.createElement('div');
      div.className='channel';
      div.innerHTML=`<div class="profile-circle">${user.username[0].toUpperCase()}</div>${user.username}`;
      div.onclick=()=>{ currentChannel=user.username; loadMessages(); }
      channelsEl.appendChild(div);
    });
  }

  async function loadMessages(){
    messagesEl.innerHTML='';
    let query;
    if(currentChannel==='global'){
      query = supabase.from('global_messages').select('*').order('created_at',{ascending:true});
    } else {
      query = supabase.from('private_messages').select('*')
        .or(`and(sender.eq.${currentUser.username},recipient.eq.${currentChannel}),and(sender.eq.${currentChannel},recipient.eq.${currentUser.username})`)
        .order('created_at',{ascending:true});
    }
    const { data } = await query;
    data.forEach(msg=>{
      const type = (msg.username===currentUser.username || msg.sender===currentUser.username)?'self':'other';
      appendMessage(msg,type);
    });
  }

  async function sendMessage(){
    if(!messageInput.value) return;
    const msgObj = { username: currentUser.username, message: messageInput.value, created_at: new Date().toISOString() };
    appendMessage(msgObj,'self');
    if(currentChannel==='global'){
      await supabase.from('global_messages').insert([msgObj]);
    } else {
      await supabase.from('private_messages').insert([{sender:currentUser.username,recipient:currentChannel,message:msgObj.message,created_at:msgObj.created_at}]);
    }
    messageInput.value='';
  }

  sendBtn.onclick=sendMessage;
  messageInput.addEventListener('keypress',e=>{ if(e.key==='Enter') sendMessage(); });

  function subscribeMessages(){
    supabase.channel('global')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'global_messages'},payload=>{
        if(currentChannel==='global' && payload.new.username!==currentUser.username)
          appendMessage(payload.new,'other');
      }).subscribe();

    supabase.channel('private')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'private_messages'},payload=>{
        const m = payload.new;
        const isRelevant=(m.sender===currentUser.username && m.recipient===currentChannel)||(m.recipient===currentUser.username && m.sender===currentChannel);
        if(isRelevant) appendMessage({username:m.sender,message:m.message,created_at:m.created_at}, m.sender===currentUser.username?'self':'other');
      }).subscribe();
  }

  let typingTimeout;
  messageInput.addEventListener('input',async ()=>{
    if(!currentUser) return;
    const channel=currentChannel==='global'?'global':currentChannel;
    await supabase.from('typing_status').upsert([{username:currentUser.username,channel,is_typing:true,updated_at:new Date().toISOString()}]);
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(async ()=>{
      await supabase.from('typing_status').upsert([{username:currentUser.username,channel,is_typing:false,updated_at:new Date().toISOString()}]);
    },2000);
  });

  async function subscribeTyping(){
    supabase.channel('typing')
      .on('postgres_changes',{event:'UPDATE',schema:'public',table:'typing_status'},payload=>{
        const t=payload.new;
        if(t.channel!==currentChannel || t.username===currentUser.username) return;
        typingIndicator.textContent = t.is_typing?`${t.username} is typing...`:'';
      }).subscribe();
  }

});
</script>
</body>
</html>


