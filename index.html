<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TexterApp</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chatDiv, #adminDiv { display: none; }
    .message { border-bottom: 1px solid #ccc; padding: 5px; }
    .admin-panel { margin-top: 20px; border: 1px solid #000; padding: 10px; }
  </style>
</head>
<body>
  <h1>ðŸ“± TexterApp</h1>

  <!-- Login -->
  <div id="loginDiv">
    <h2>Login</h2>
    <input type="text" id="loginUsername" placeholder="Username"><br>
    <input type="password" id="loginPassword" placeholder="Password"><br>
    <button id="loginBtn">Login</button>
  </div>

  <!-- Chat -->
  <div id="chatDiv">
    <h2>Chat</h2>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <!-- Admin -->
  <div id="adminDiv" class="admin-panel">
    <h2>Admin Panel</h2>
    <h3>Create User</h3>
    <input type="text" id="newUsername" placeholder="New Username"><br>
    <input type="password" id="newPassword" placeholder="Password"><br>
    <select id="newRole">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select><br>
    <button id="createUserBtn">Create User</button>

    <h3>Delete User</h3>
    <input type="text" id="deleteUsername" placeholder="Username to Delete"><br>
    <button id="deleteUserBtn">Delete User</button>
  </div>

  <script>
    const SUPABASE_URL = "YOUR_SUPABASE_URL";  // replace with your project URL
    const SUPABASE_KEY = "YOUR_SUPABASE_KEY";  // replace with anon/public key
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    // Login with username + password
    document.getElementById('loginBtn').onclick = async () => {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      if (!username || !password) return alert("Enter username & password");

      // Look up user
      const { data: userRow, error: lookupError } = await client
        .from('users')
        .select('id, role')
        .eq('username', username)
        .single();

      if (lookupError || !userRow) return alert("Username not found");

      // Get email from auth by userId
      const { data: authUser, error: authError } = await client.auth.admin.getUserById(userRow.id);
      if (authError || !authUser.user) return alert("Could not find account");

      const email = authUser.user.email;

      // Sign in
      const { data, error } = await client.auth.signInWithPassword({ email, password });
      if (error) return alert("Login failed: " + error.message);

      currentUser = { ...data.user, role: userRow.role, username };

      document.getElementById('loginDiv').style.display = 'none';
      document.getElementById('chatDiv').style.display = 'block';

      if (currentUser.role === "admin") {
        document.getElementById('adminDiv').style.display = 'block';
      }

      loadMessages();
      setupRealtime();
    };

    // Send message
    document.getElementById('sendBtn').onclick = async () => {
      const content = document.getElementById('messageInput').value.trim();
      if (!content) return;

      await client.from('messages').insert([{ content, username: currentUser.username }]);
      document.getElementById('messageInput').value = '';
    };

    // Logout
    document.getElementById('logoutBtn').onclick = async () => {
      await client.auth.signOut();
      currentUser = null;
      document.getElementById('chatDiv').style.display = 'none';
      document.getElementById('adminDiv').style.display = 'none';
      document.getElementById('loginDiv').style.display = 'block';
    };

    // Load messages
    async function loadMessages() {
      const { data, error } = await client.from('messages').select().order('created_at', { ascending: true });
      if (error) return console.error(error);
      renderMessages(data);
    }

    function renderMessages(messages) {
      const container = document.getElementById('messages');
      container.innerHTML = '';
      messages.forEach(m => {
        const div = document.createElement('div');
        div.className = 'message';
        div.textContent = `${m.username}: ${m.content}`;
        container.appendChild(div);
      });
    }

    // Realtime
    function setupRealtime() {
      client.channel('room1')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          const m = payload.new;
          const div = document.createElement('div');
          div.className = 'message';
          div.textContent = `${m.username}: ${m.content}`;
          document.getElementById('messages').appendChild(div);
        })
        .subscribe();
    }

    // Admin: Create user
    document.getElementById('createUserBtn').onclick = async () => {
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value.trim();
      const role = document.getElementById('newRole').value;
      if (!username || !password) return alert("Fill in all fields");

      const fakeEmail = `${username}@app.local`;

      // Create auth user
      const { data: newAuthUser, error: authErr } = await client.auth.admin.createUser({
        email: fakeEmail,
        password,
        email_confirm: true
      });
      if (authErr) return alert("Error creating user: " + authErr.message);

      // Save username + role in users table
      await client.from('users').insert([{ id: newAuthUser.user.id, username, role }]);
      alert("User created!");
    };

    // Admin: Delete user
    document.getElementById('deleteUserBtn').onclick = async () => {
      const username = document.getElementById('deleteUsername').value.trim();
      if (!username) return;

      const { data: userRow, error } = await client.from('users').select('id').eq('username', username).single();
      if (error || !userRow) return alert("User not found");

      // Delete from auth
      await client.auth.admin.deleteUser(userRow.id);
      // Delete from users table
      await client.from('users').delete().eq('username', username);

      alert("User deleted!");
    };
  </script>
</body>
</html>
