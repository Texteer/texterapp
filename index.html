<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supabase Chat with Login</title>
<style>
body { font-family: Arial; background:#f0f0f0; padding:20px;}
#loginDiv, #chatDiv { border:1px solid #ccc; padding:20px; background:#fff; margin-bottom:20px;}
#messages { border:1px solid #ccc; height:300px; overflow-y:auto; padding:10px; margin-bottom:10px;}
input[type=text], input[type=password] { width: calc(100% - 20px); padding:10px; margin-bottom:10px; box-sizing:border-box;}
button { padding:10px 20px; cursor:pointer; margin-right:5px;}
#adminPanel { display:none; border:1px solid #ccc; padding:10px; background:#eee; margin-bottom:10px;}
</style>
</head>
<body>

<div id="loginDiv">
  <h2>Login</h2>
  <input type="text" id="loginEmail" placeholder="Email"><br>
  <input type="password" id="loginPassword" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
</div>

<div id="chatDiv" style="display:none;">
  <h2>Chat Room</h2>

  <div id="adminPanel">
    <h3>Admin Panel</h3>
    <p>Placeholder buttons (actual account creation/deletion requires server-side setup)</p>
    <button onclick="alert('Create User clicked')">Create User</button>
    <button onclick="alert('Delete User clicked')">Delete User</button>
  </div>

  <div id="messages"></div>
  <input type="text" id="message" placeholder="Type your message">
  <button id="sendBtn">Send</button>
  <button id="logoutBtn">Logout</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// --- Supabase setup ---
const supabaseUrl = 'https://fhokwoazuhkwrkrweddd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc';
const client = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;

// --- Login ---
document.getElementById('loginBtn').onclick = async () => {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) { alert("Enter email & password"); return; }

  const { data, error } = await client.auth.signInWithPassword({ email, password });
  if (error) { alert("Login failed: "+error.message); return; }

  currentUser = data.user;
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('chatDiv').style.display='block';

  checkAdmin();
  loadMessages();
  setupRealtime();
};

// --- Logout ---
document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  currentUser = null;
  document.getElementById('chatDiv').style.display='none';
  document.getElementById('loginDiv').style.display='block';
};

// --- Chat ---
const messagesDiv = document.getElementById('messages');
document.getElementById('sendBtn').onclick = async () => {
  const text = document.getElementById('message').value.trim();
  if(!text) return;
  const { error } = await client.from('messages').insert([{ username: currentUser.email, message: text }]);
  if(error) alert("Error: "+error.message);
  else document.getElementById('message').value='';
};

// Load previous messages
async function loadMessages(){
  const { data } = await client.from('messages').select('*').order('created_at',{ascending:true});
  messagesDiv.innerHTML='';
  data.forEach(d=>{
    const p = document.createElement('p');
    p.textContent = d.username+": "+d.message;
    messagesDiv.appendChild(p);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Realtime
function setupRealtime(){
  client.channel('room1').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, payload=>{
    const p = document.createElement('p');
    p.textContent = payload.new.username+": "+payload.new.message;
    messagesDiv.appendChild(p);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }).subscribe();
}

// Admin Panel (client-side only)
async function checkAdmin(){
  const { data } = await client.from('users').select('*').eq('id', currentUser.id).single();
  if(data && data.role==='admin'){
    document.getElementById('adminPanel').style.display='block';
  }
}
</script>

</body>
</html>
