<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Supabase Chat</title>
<style>
  /* Your CSS styles (unchanged from your original code) */
  body {
    font-family: Arial, sans-serif;
    background: #0d1117;
    color: #f0f6fc;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  #app {
    width: 90%;
    max-width: 600px;
    background: #161b22;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
  }
  h2 {
    text-align: center;
    color: #58a6ff;
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    border: none;
    box-sizing: border-box;
  }
  input {
    background: #0d1117;
    color: #f0f6fc;
    border: 1px solid #30363d;
  }
  button {
    background: #238636;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background: #2ea043;
  }
  #messages {
    border: 1px solid #30363d;
    height: 300px;
    overflow-y: auto;
    background: #0d1117;
    padding: 10px;
    margin: 10px 0;
    border-radius: 5px;
  }
</style>
</head>
<body>
<div id="app">
<h2>Supabase Chat</h2>

<!-- Login Page -->
<div id="login">
  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email" />
  <input type="password" id="loginPassword" placeholder="Password" />
  <button id="loginBtn">Login</button>
</div>

<!-- Username Setup -->
<div id="set-username" style="display:none;">
  <h3>Create Your Username</h3>
  <input type="text" id="newUsername" placeholder="Choose a username (max 15 chars, no symbols)" />
  <button id="saveUsernameBtn">Save Username</button>
</div>

<!-- Main App -->
<div id="main-app" style="display:none;">
  <header>
    <div class="brand">Texter</div>
    <div class="me" id="meInfo">Signed in as —</div>
  </header>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="section-title">Find friends</div>
    <div class="search">
      <input id="searchBox" type="text" placeholder="Search username…" />
    </div>
    <div class="results" id="searchResults"></div>

    <div class="section-title">Requests</div>
    <div class="results" id="requests"></div>

    <div class="section-title">Friends</div>
    <div class="friends" id="friends"></div>
  </aside>

  <!-- Chat section -->
  <section class="chat">
    <div class="chat-header">
      <div class="avatar" id="roomAvatar">GC</div>
      <div class="chat-title" id="roomTitle">Global Chat</div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="composer">
      <input id="composerInput" type="text" placeholder="Type a message… (Enter to send)" />
      <button id="sendBtn" class="btn primary send-mobile">Send</button>
    </div>
  </section>
</div>
</div>

<!-- Include Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<script>
  // Initialize Supabase client FIRST
  const supabaseUrl = "https://fhokwoazuhkwrkrweddd.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // State variables
  let currentUser = null;
  let currentUsername = null;

  // Utility functions
  const $ = (id) => document.getElementById(id);
  const showSection = (id) => {
    document.querySelectorAll('#login, #set-username, #main-app').forEach(el => el.style.display = 'none');
    $(id).style.display = 'block';
  };
  const initials = (name='?') => {
    const parts = name.trim().split(/[\s_]+/);
    const a = (parts[0]||'')[0]||'?';
    const b = (parts[1]||'')[0]||'';
    return (a + b).toUpperCase();
  };

  // Immediately check session on load
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session && session.user) {
      await afterLogin(session.user);
    } else {
      showSection('login');
    }
  })();

  // Setup auth state change listener
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_OUT') {
      currentUser = null;
      currentUsername = null;
      showSection('login');
    } else if (session && session.user) {
      await afterLogin(session.user);
    }
  });

  // Login button handler
  document.getElementById('loginBtn').onclick = async () => {
    const email = $('#loginEmail').value.trim();
    const password = $('#loginPassword').value.trim();
    if (!email || !password) {
      alert('Please enter email and password.');
      return;
    }
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      alert('Login failed: ' + error.message);
    } else {
      await afterLogin(data.user);
    }
  };

  // After login / session restore
  async function afterLogin(user) {
    currentUser = user;
    // Check if user record exists in 'users' table
    const { data: userRecord, error } = await supabase
      .from('users')
      .select('username')
      .eq('email', user.email)
      .maybeSingle();

    if (error) {
      console.error('Error fetching user:', error);
    }

    if (userRecord && userRecord.username) {
      currentUsername = userRecord.username;
      initApp();
    } else {
      showSection('set-username');
    }
  }

  // Save username handler
  document.getElementById('saveUsernameBtn').onclick = async () => {
    const usernameInput = $('#newUsername').value.trim();
    if (!/^[a-zA-Z0-9_]{1,15}$/.test(usernameInput)) {
      alert('Use letters/numbers/underscore only, max 15.');
      return;
    }
    // Check for duplicate username
    const { data: exists } = await supabase
      .from('users')
      .select('username')
      .eq('username', usernameInput)
      .maybeSingle();
    if (exists) {
      alert('That username is taken.');
      return;
    }
    // Insert or update user record
    const { error } = await supabase
      .from('users')
      .upsert({ email: currentUser.email, username: usernameInput }, { onConflict: 'email' });
    if (error) {
      alert('Error saving username: ' + error.message);
      return;
    }
    currentUsername = usernameInput;
    initApp();
  };

  // Initialize main app
  async function initApp() {
    showSection('main-app');
    $('#meInfo').textContent = `${currentUsername} (${currentUser.email})`;
    setRoomHeader('Global Chat', 'GC');
    loadFriends();
    loadRequests();
    loadGlobalMessages();
    subscribeGlobal();

    $('#composerInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !isMobile()) {
        e.preventDefault();
        sendMessage();
      }
    });
    $('#sendBtn').onclick = sendMessage;
  }

  // Helper: mobile detection
  const isMobile = () => matchMedia('(max-width: 900px)').matches || 'ontouchstart' in window;

  // Set chat header
  function setRoomHeader(title, initialsTxt) {
    $('#roomTitle').textContent = title;
    $('#roomAvatar').textContent = initialsTxt;
  }

  // Send message
  async function sendMessage() {
    const message = $('#composerInput').value.trim();
    if (!message || !currentUser || !currentUsername) return;

    if (currentView?.type === 'global') {
      const { error } = await supabase
        .from('messages')
        .insert({ username: currentUsername, message, sender_email: currentUser.email });
      if (!error) $('#composerInput').value = '';
    } else if (currentView?.type === 'dm') {
      const { error } = await supabase
        .from('dm_messages')
        .insert({
          sender_email: currentUser.email,
          receiver_email: currentView.peerEmail,
          content: message
        });
      if (!error) $('#composerInput').value = '';
    }
  }

  // Load global messages
  async function loadGlobalMessages() {
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .order('created_at', { ascending: true });
    if (error) {
      console.error(error);
      return;
    }
    const msgDiv = $('#messages');
    msgDiv.innerHTML = '';
    data.forEach(m => appendBubble(msgDiv, m.username, m.sender_email === currentUser.email, m.message));
  }

  // Subscribe to new messages
  function subscribeGlobal() {
    supabase
      .channel('global-feed')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
        if (currentView?.type === 'global') {
          appendBubble($('#messages'), payload.new.username, payload.new.sender_email === currentUser.email, payload.new.message);
        }
      })
      .subscribe();
  }

  // Other functions (openDM, searchUsers, etc.) omitted for brevity...
  // (You can keep your existing implementations here)

  // Append message bubble
  function appendBubble(container, fromName, mine, text) {
    const wrap = document.createElement('div');
    wrap.className = `bubble ${mine ? 'me' : 'them'}`;
    wrap.innerHTML = `
      <div class="from">
        <div class="avatar" style="width:26px;height:26px;font-size:.75rem;">${initials(fromName)}</div>
        <div>${fromName}</div>
      </div>
      <div>${escapeHtml(text)}</div>
    `;
    container.appendChild(wrap);
    container.scrollTop = container.scrollHeight;
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch]));
  }
</script>
</body>
</html>
