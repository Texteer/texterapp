<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Texter â€” Desktop Chat</title>
<style>
:root {
  --bg:#0b1020; --panel:#121a2b; --panel-2:#0f172a; --accent:#3b82f6;
  --text:#e5e7eb; --muted:#8aa0c6; --border:#1f2a44; --me:#2563eb;
  --them:#1f2937; --danger:#ef4444; --success:#22c55e;
}
* {box-sizing:border-box;}
body {margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;justify-content:center;align-items:center;}
.app {width:100%; max-width:1100px; height:92vh; display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr auto; grid-template-areas:"header header" "sidebar chat" "sidebar input"; gap:10px; background:var(--bg); border:1px solid var(--border); border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.4);}
header {grid-area:header; background:var(--panel); padding:14px 18px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border);}
.brand {color:var(--accent); font-weight:700;}
.meInfo {color:var(--muted);}
.sidebar {grid-area:sidebar; background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column;}
.sidebar-top {display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--border);}
.results, .friends {overflow:auto; flex:1; padding-bottom:8px;}
.search input {width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:#071228; color:var(--text);}
.list-item {display:flex; gap:10px; align-items:center; padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.03);}
.list-item:hover {background:#0e1730;}
.avatar {width:36px; height:36px; border-radius:50%; display:grid; place-items:center; font-weight:700; color:#cde1ff; background:#0e2a5a; border:1px solid #18325e;}
.meta .name {font-size:.95rem;}
.meta .muted {color:var(--muted); font-size:.82rem;}
.badge {background:var(--danger); color:white; border-radius:999px; padding:2px 8px; font-size:12px;}
.chat {grid-area:chat; display:flex; flex-direction:column; background:var(--panel-2);}
.chat-header {padding:12px 16px; border-bottom:1px solid var(--border); display:flex; gap:10px; align-items:center;}
.messages {flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px;}
.bubble {max-width:78%; padding:10px 12px; border-radius:12px; line-height:1.3; word-wrap:break-word;}
.bubble.me {align-self:flex-end; background:var(--me); color:white;}
.bubble.them {align-self:flex-start; background:var(--them); color:#e6eefc;}
.bubble .from {display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:.82rem; color:#cdd8ff;}
.composer {grid-area:input; display:flex; gap:10px; padding:12px; background:var(--panel); border-top:1px solid var(--border);}
.composer input {flex:1; padding:12px; border-radius:10px; border:1px solid var(--border); background:#071228; color:var(--text);}
.btn {padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0c1426; color:var(--text); cursor:pointer;}
.btn.primary {background:var(--accent); border-color:transparent;}
.typing-indicator {font-size:.85rem;color:#aaa;margin-bottom:4px;}
.overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:60; }
.card{background:var(--panel); padding:18px; border-radius:10px; border:1px solid var(--border); width:95%; max-width:420px;}
.note{color:var(--muted); font-size:.9rem;}
.small{font-size:.85rem; color:var(--muted);}
</style>
</head>
<body>

<!-- AUTH modal -->
<div id="authOverlay" class="overlay" style="display:none;">
  <div class="card">
    <h2 style="color:var(--accent)">Welcome</h2>
    <p class="note">Log in with email & password.</p>
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPassword" type="password" placeholder="Password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="loginBtn" class="btn primary">Log in</button>
      <button id="signupBtn" class="btn">Sign up</button>
    </div>
  </div>
</div>

<!-- USERNAME modal -->
<div id="usernameOverlay" class="overlay" style="display:none;">
  <div class="card">
    <h3 style="color:var(--accent)">Pick a username</h3>
    <input id="usernameField" type="text" placeholder="e.g. alex_99" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="saveUsername" class="btn primary">Save</button>
    </div>
    <p id="usernameError" class="small" style="color:var(--danger);display:none;margin-top:8px"></p>
  </div>
</div>

<!-- MAIN APP -->
<div id="appRoot" class="app" style="display:none;">
  <header>
    <div class="brand">Texter</div>
    <div class="meInfo" id="meInfo">â€”</div>
  </header>

  <aside class="sidebar">
    <div class="sidebar-top">
      <button id="toggleAdd" class="btn">âž• Add</button>
      <button id="toggleReq" class="btn">ðŸ”” Requests <span id="reqCount" class="badge" style="display:none;margin-left:6px">0</span></button>
      <button id="logoutBtn" class="btn" style="margin-left:auto">Sign out</button>
    </div>
    <div style="padding:10px;border-bottom:1px solid var(--border)">
      <div class="search"><input id="searchBox" placeholder="Search usernameâ€¦" /></div>
    </div>
    <div class="friends" id="friendsList"></div>
  </aside>

  <section class="chat">
    <div class="chat-header">
      <div class="avatar" id="roomAvatar">GC</div>
      <div class="chat-title" id="roomTitle">Global Chat</div>
    </div>
    <div class="typing-indicator" id="typingIndicator"></div>
    <div class="messages" id="messages"></div>
  </section>

  <div class="composer">
    <input id="composerInput" placeholder="Type a messageâ€¦ (Enter to send)" />
    <button id="sendBtn" class="btn primary">Send</button>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON = "YOUR_SUPABASE_ANON_KEY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

let me={email:null,username:null};
let session=null;
let currentView={type:'global',peerEmail:null,peerUsername:null};
let messagesDedup=new Set();
let globalChannel=null, dmChannel=null;

const $ = id => document.getElementById(id);

/* AUTH */
$('loginBtn').addEventListener('click', async()=>{
  const email=$('loginEmail').value.trim(), password=$('loginPassword').value;
  if(!email||!password)return alert("Enter email & password");
  const { data, error } = await sb.auth.signInWithPassword({email,password});
  if(error) return alert("Login error: "+error.message);
  await afterLogin(data.user);
});
$('signupBtn').addEventListener('click', async()=>{
  const email=$('loginEmail').value.trim(), password=$('loginPassword').value;
  if(!email||!password)return alert("Enter email & password");
  const { data, error } = await sb.auth.signUp({email,password});
  if(error) return alert("Signup error: "+error.message);
  alert("Signed up â€” check email to confirm then log in.");
});
$('logoutBtn').addEventListener('click', async()=>{await sb.auth.signOut(); me={email:null,username:null}; messagesDedup.clear(); showAuth();});

/* UI helpers */
function showAuth(){ $('authOverlay').style.display='flex'; $('usernameOverlay').style.display='none'; $('appRoot').style.display='none'; }
function showUsername(){ $('authOverlay').style.display='none'; $('usernameOverlay').style.display='flex'; $('appRoot').style.display='none'; }
function showApp(){ $('authOverlay').style.display='none'; $('usernameOverlay').style.display='none'; $('appRoot').style.display='grid'; }

/* After login */
async function afterLogin(user){
  me.email=user.email;
  const { data:row } = await sb.from('users').select('username').eq('email',me.email).maybeSingle();
  if(!row||!row.username){ $('usernameField').value=''; showUsername(); } 
  else { me.username=row.username; showApp(); startApp(); }
}
/* Save username first-time */
$('saveUsername').addEventListener('click', async()=>{
  const u=$('usernameField').value.trim();
  if(!/^[A-Za-z0-9_]{1,15}$/.test(u)) return $('usernameError').innerText="Invalid username"; $('usernameError').style.display='block';
  const { data: exists } = await sb.from('users').select('email').eq('username',u).maybeSingle();
  if(exists) return $('usernameError').innerText="Username taken"; $('usernameError').style.display='block';
  await sb.from('users').upsert({email:me.email,username:u},{onConflict:'email'});
  me.username=u; showApp(); startApp();
});

/* Start App */
function startApp(){
  $('meInfo').innerText=`${me.username} â€” ${me.email}`;
  loadGlobalMessages(); subscribeGlobal(); wireComposer(); loadFriends(); loadRequests();
}

/* Add message */
function addMessageToUI(m){
  const key=m.id||m.sender_email+m.content+m.created_at;
  if(messagesDedup.has(key)) return;
  messagesDedup.add(key);
  const container=$('messages'); 
  const div=document.createElement('div'); div.className='bubble '+(m.sender_email===me.email?'me':'them');
  const time=new Date(m.created_at||new Date()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  if(m.sender_email!==me.email){
    div.innerHTML=`<div class="from"><div class="avatar">${m.username[0]}</div>${m.username} <span style="font-size:.7rem;color:#aaa">${time}</span></div>${m.content}`;
  } else div.innerHTML=`${m.content} <span style="font-size:.7rem;color:#aaa">${time}</span>`;
  container.appendChild(div);
  container.scrollTop=container.scrollHeight;
}

/* Load global messages */
async function loadGlobalMessages(){
  const { data } = await sb.from('global_messages').select('*').order('created_at',{ascending:true});
  $('messages').innerHTML=''; messagesDedup.clear();
  (data||[]).forEach(m=>addMessageToUI({username:m.sender_username, ...m}));
}

/* Subscribe global messages */
function subscribeGlobal(){
  if(globalChannel) sb.removeChannel(globalChannel);
  globalChannel = sb.channel('public:global_messages')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'global_messages'},payload=>addMessageToUI({username:payload.new.sender_username,...payload.new}))
    .subscribe();
}

/* Composer */
function wireComposer(){
  const input=$('composerInput');
  $('sendBtn').addEventListener('click', sendMessage);
  input.addEventListener('keydown', async e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});
}

async function sendMessage(){
  const input=$('composerInput');
  const txt=input.value.trim();
  if(!txt) return;
  input.value='';
  addMessageToUI({username:me.username,message:txt,sender_email:me.email,created_at:new Date().toISOString()});
  const { error } = await sb.from('global_messages').insert({sender_email:me.email,sender_username:me.username,content:txt});
  if(error) console.error(error);
}

/* Friends & Requests placeholders (can add full realtime like above) */
async function loadFriends(){ /* implement friends loading */ }
async function loadRequests(){ /* implement requests loading */ }

</script>
</body>
</html>
