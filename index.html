<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supabase Chat with Admin Panel</title>
<style>
body { font-family: Arial; background:#f0f0f0; padding:20px; }
#loginDiv, #chatDiv { border:1px solid #ccc; padding:20px; background:#fff; margin-bottom:20px; }
#messages { border:1px solid #ccc; height:300px; overflow-y:auto; padding:10px; margin-bottom:10px; }
input[type=text], input[type=password] { width: calc(100% - 20px); padding:10px; margin-bottom:10px; box-sizing:border-box; }
button { padding:10px 20px; cursor:pointer; margin-right:5px; }
#adminPanel { display:none; border:1px solid #ccc; padding:10px; background:#eee; margin-bottom:10px; }
ul { list-style:none; padding-left:0; }
ul li { margin-bottom:5px; }
</style>
</head>
<body>

<div id="loginDiv">
  <h2>Login</h2>
  <input type="text" id="loginEmail" placeholder="Email"><br>
  <input type="password" id="loginPassword" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
</div>

<div id="chatDiv" style="display:none;">
  <h2>Chat Room</h2>

  <div id="adminPanel">
    <h3>Admin Panel</h3>
    <input type="text" id="newUserEmail" placeholder="New user email"><br>
    <input type="text" id="newUserPassword" placeholder="New user password"><br>
    <select id="newUserRole"><option value="user">User</option><option value="admin">Admin</option></select>
    <button id="createUserBtn">Create User</button>
    <h4>Existing Users</h4>
    <ul id="userList"></ul>
  </div>

  <div id="messages"></div>
  <input type="text" id="message" placeholder="Type your message">
  <button id="sendBtn">Send</button>
  <button id="logoutBtn">Logout</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://fhokwoazuhkwrkrweddd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc';
const client = supabase.createClient(supabaseUrl, supabaseKey);
let currentUser = null;

// --- Login ---
document.getElementById('loginBtn').onclick = async () => {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) { alert("Enter email & password"); return; }

  const { data, error } = await client.auth.signInWithPassword({ email, password });
  if (error) { alert("Login failed: "+error.message); return; }

  currentUser = data.user;
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('chatDiv').style.display='block';

  checkAdmin();
  loadMessages();
  setupRealtime();
};

// --- Logout ---
document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  currentUser = null;
  document.getElementById('chatDiv').style.display='none';
  document.getElementById('loginDiv').style.display='block';
};

// --- Chat ---
const messagesDiv = document.getElementById('messages');
document.getElementById('sendBtn').onclick = async () => {
  const text = document.getElementById('message').value.trim();
  if(!text) return;
  const { error } = await client.from('messages').insert([{ username: currentUser.email, message: text }]);
  if(error) alert("Error: "+error.message);
  else document.getElementById('message').value='';
};

async function loadMessages(){
  const { data } = await client.from('messages').select('*').order('created_at',{ascending:true});
  messagesDiv.innerHTML='';
  data.forEach(d=>{
    const p = document.createElement('p');
    p.textContent = d.username+": "+d.message;
    messagesDiv.appendChild(p);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function setupRealtime(){
  client.channel('room1').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, payload=>{
    const p = document.createElement('p');
    p.textContent = payload.new.username+": "+payload.new.message;
    messagesDiv.appendChild(p);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }).subscribe();
}

// --- Admin Panel ---
async function checkAdmin(){
  const { data } = await client.from('users').select('*').eq('id', currentUser.id).single();
  if(data && data.role==='admin'){
    document.getElementById('adminPanel').style.display='block';
    loadUsers();
  }
}

// Load users for admin
async function loadUsers(){
  const { data } = await client.from('users').select('*');
  const list = document.getElementById('userList'); list.innerHTML='';
  data.forEach(u=>{
    const li=document.createElement('li');
    li.textContent=u.username+' ('+u.role+') ';
    const delBtn=document.createElement('button'); delBtn.textContent='Delete';
    delBtn.onclick = () => deleteUser(u.id);
    li.appendChild(delBtn);
    list.appendChild(li);
  });
}

// Create user (calls Edge Function)
document.getElementById('createUserBtn').onclick = async () => {
  const email = document.getElementById('newUserEmail').value.trim();
  const password = document.getElementById('newUserPassword').value.trim();
  const role = document.getElementById('newUserRole').value;
  if (!email || !password) return alert('Email & password required');

  const res = await fetch('https://supabase.com/dashboard/project/fhokwoazuhkwrkrweddd/functions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-admin-secret': 'ADMIN_SECRET' },
    body: JSON.stringify({ action:'create', email, password, role })
  });
  const data = await res.json();
  if(data.error) alert(data.error); else { alert('User created'); loadUsers(); }
}

// Delete user (calls Edge Function)
async function deleteUser(userId){
  const res = await fetch('https://<project>.functions.supabase.co/manage-users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-admin-secret': '<YOUR_ADMIN_SECRET>' },
    body: JSON.stringify({ action:'delete', userId })
  });
  const data = await res.json();
  if(data.error) alert(data.error); else { alert('User deleted'); loadUsers(); }
}
</script>
</body>
</html>
