<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Snapchat-Style Chat</title>
  <title>Texter — Global & DMs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0d1117; color: #fff; }
    #app { display: flex; height: 100vh; }
    #sidebar { width: 250px; background: #161b22; padding: 10px; overflow-y: auto; }
    #chatArea { flex: 1; display: flex; flex-direction: column; background: #0d1117; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; }
    #inputArea { display: flex; padding: 10px; border-top: 1px solid #333; }
    #message { flex: 1; padding: 10px; border: none; border-radius: 5px; }
    .msg { margin: 5px 0; padding: 8px 12px; border-radius: 15px; max-width: 60%; word-wrap: break-word; }
    .msg.mine { background: #1e40af; align-self: flex-end; }
    .msg.theirs { background: #2d3748; align-self: flex-start; }
    .friend { padding: 10px; cursor: pointer; border-radius: 5px; }
    .friend:hover { background: #2d3748; }
    .hidden { display: none; }
    .popup { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: #161b22; border: 1px solid #333; padding: 20px; border-radius: 10px; }
    .btn { background: #1e40af; color: #fff; padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #2563eb; }
    .topbar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #161b22; border-bottom: 1px solid #333; }
    .badge { background: red; color: #fff; border-radius: 50%; padding: 3px 7px; font-size: 12px; margin-left: 5px; }
    :root {
      --bg:#0b1020;
      --panel:#121a2b;
      --panel-2:#0f172a;
      --accent:#3b82f6;
      --accent-2:#60a5fa;
      --text:#e5e7eb;
      --muted:#8aa0c6;
      --border:#1f2a44;
      --me:#1d4ed8;
      --them:#1f2937;
      --danger:#ef4444;
      --success:#22c55e;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      background:linear-gradient(140deg,#000,#0b1a33 45%,#000);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    /* App layout */
    .app {
      width:100%; max-width:1100px; height:92vh;
      display:grid; gap:10px;
      grid-template-columns:280px 1fr;
      grid-template-rows:auto 1fr auto;
      grid-template-areas:
        "header header"
        "sidebar chat"
        "sidebar input";
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.4);
    }
    header {
      grid-area:header;
      background:var(--panel);
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
    }
    header .brand { font-weight:700; letter-spacing:.4px; color:var(--accent-2); }
    header .me { font-size:.95rem; color:var(--muted); }

    /* Sidebar */
    .sidebar {
      grid-area:sidebar;
      background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
    }
    .sidebar .section-btn {
      padding:12px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.9rem;
      color:var(--accent-2);
    }
    .sidebar .badge {
      background:var(--danger);
      color:#fff;
      border-radius:10px;
      padding:2px 8px;
      font-size:.75rem;
    }
    .hidden { display:none; }
    .search, .results, .friends { overflow:auto; }
    .search input {
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:#0c1426; color:var(--text);
    }
    .list-item {
      display:flex; gap:10px; align-items:center;
      padding:10px 12px; cursor:pointer;
      border-bottom:1px solid rgba(255,255,255,.03);
    }
    .list-item:hover { background:#0e1730; }
    .list-item .meta { display:flex; flex-direction:column; }
    .name { font-size:.95rem; }
    .muted { color:var(--muted); font-size:.8rem; }
    .btn {
      padding:6px 10px; font-size:.8rem;
      border-radius:8px; border:1px solid var(--border);
      background:#0c1426; color:var(--text);
      cursor:pointer;
    }
    .btn.primary { background:var(--accent); border-color:transparent; }
    .btn.success { background:var(--success); border-color:transparent; }
    .btn.danger { background:var(--danger); border-color:transparent; }
    .avatar {
      width:34px; height:34px; border-radius:50%; background:#0e2a5a;
      display:grid; place-items:center; color:#cde1ff; font-weight:700;
      font-size:.9rem; border:1px solid #18325e;
    }

    /* Chat area */
    .chat { grid-area:chat; display:flex; flex-direction:column; background:var(--panel-2); }
    .chat-header {
      padding:12px 16px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:10px;
    }
    .chat-title { font-weight:600; }
    .messages { flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px; }
    .bubble {
      max-width:72%; padding:10px 12px; border-radius:12px; line-height:1.3;
      position:relative; word-wrap:break-word;
    }
    .bubble.me { align-self:flex-end; background:var(--me); }
    .bubble.them { align-self:flex-start; background:var(--them); }
    .bubble .from {
      display:flex; align-items:center; gap:8px;
      margin-bottom:6px; font-size:.82rem; color:#cdd8ff;
    }

    /* Composer */
    .composer {
      grid-area:input;
      display:flex; gap:10px; padding:12px;
      background:var(--panel);
      border-top:1px solid var(--border);
    }
    .composer input {
      flex:1; padding:12px 14px; border-radius:10px;
      border:1px solid var(--border);
      background:#0c1426; color:var(--text);
    }
    .send-mobile { display:none; }
    @media (max-width:900px) {
      .app { grid-template-columns:1fr; grid-template-areas:"header" "chat" "input"; }
      .sidebar { display:none; }
      .send-mobile { display:inline-flex; }
    }

    /* Auth screens */
    .auth-wrap {
      width:100%; max-width:420px; background:var(--panel);
      border:1px solid var(--border); border-radius:12px;
      padding:18px; box-shadow:0 10px 40px rgba(0,0,0,.35);
    }
    .auth input, .auth button {
      width:100%; margin:6px 0;
      padding:12px 14px; border-radius:10px;
    }
    .auth input {
      background:#0c1426; border:1px solid var(--border); color:var(--text);
    }
    .auth button {
      background:var(--accent); border:none; color:#fff; cursor:pointer;
    }
    .note { color:var(--muted); font-size:.85rem; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="auth" class="auth" style="display:none;">
    <div class="auth-wrap">
      <h2 style="color:var(--accent-2)">Welcome back</h2>
      <p class="note">Log in with your email & password. First-time users will be asked to set a username.</p>
      <input type="email" id="loginEmail" placeholder="Email" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button id="loginBtn">Log In</button>
    </div>
  </div>

<div id="loginDiv">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button id="loginBtn" class="btn">Login</button>
</div>

<div id="app" class="hidden">
  <div id="sidebar">
    <div class="topbar">
      <span>Friends</span>
      <div>
        <button id="showRequestsBtn" class="btn">Requests <span id="reqBadge" class="badge hidden">0</span></button>
        <button id="addFriendBtn" class="btn">+</button>
      </div>
  <!-- Username Setup -->
  <div id="usernameSetup" class="auth" style="display:none;">
    <div class="auth-wrap">
      <h2 style="color:var(--accent-2)">Create your username</h2>
      <p class="note">Max 15 characters. Letters/numbers/underscores only.</p>
      <input type="text" id="usernameInput" placeholder="e.g. alex_p" />
      <button id="saveUsernameBtn">Save Username</button>
    </div>
    <div id="friendsList"></div>
  </div>
  <div id="chatArea">
    <div class="topbar"><span id="chatTitle">Global Chat</span></div>
    <div id="messages"></div>
    <div id="inputArea">
      <input type="text" id="message" placeholder="Type a message...">

  <!-- Main App -->
  <div id="app" class="app" style="display:none;">
    <header>
      <div class="brand">Texter</div>
      <div class="me" id="meInfo"></div>
    </header>

    <aside class="sidebar">
      <div class="section-btn" id="toggleSearch">Find Friends</div>
      <div id="searchSection" class="hidden">
        <div class="search"><input id="searchBox" type="text" placeholder="Search username…" /></div>
        <div class="results" id="searchResults"></div>
      </div>

      <div class="section-btn" id="toggleRequests">
        Requests <span id="reqBadge" class="badge hidden">0</span>
      </div>
      <div id="requestsSection" class="hidden">
        <div class="results" id="requests"></div>
      </div>

      <div class="section-btn">Friends</div>
      <div class="friends" id="friends"></div>
    </aside>

    <section class="chat">
      <div class="chat-header">
        <div class="avatar" id="roomAvatar">GC</div>
        <div class="chat-title" id="roomTitle">Global Chat</div>
      </div>
      <div class="messages" id="messages"></div>
    </section>

    <div class="composer">
      <input id="composerInput" type="text" placeholder="Type a message…" />
      <button id="sendBtn" class="btn primary send-mobile">Send</button>
    </div>
  </div>
</div>

<!-- Add Friend Popup -->
<div id="addFriendPopup" class="popup hidden">
  <h3>Add Friend</h3>
  <input type="text" id="friendEmail" placeholder="Friend's email"><br>
  <button id="sendFriendReq" class="btn">Send Request</button>
  <button id="closeAddFriend" class="btn">X</button>
</div>

<!-- Requests Popup -->
<div id="requestsPopup" class="popup hidden">
  <h3>Friend Requests</h3>
  <div id="requestsList"></div>
  <button id="closeRequests" class="btn">X</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const client = supabase.createClient(
    "https://fhokwoazuhkwrkrweddd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc"
  );

  let currentUser = null;
  let currentChat = { type: "global", id: null };

  async function init() {
    const { data } = await client.auth.getSession();
    if (data.session) {
      currentUser = data.session.user;
      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      loadFriends();
      subscribeToMessages();
      loadMessages();
    }
  }

  document.getElementById("loginBtn").onclick = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const { data, error } = await client.auth.signInWithPassword({ email, password });
    if (error) { alert(error.message); return; }
    currentUser = data.user;
    document.getElementById("loginDiv").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    loadFriends();
    subscribeToMessages();
    loadMessages();
  };

  async function loadMessages() {
    document.getElementById("messages").innerHTML = "";
    let query = client.from("messages").select("*").order("created_at", { ascending: true });
    if (currentChat.type === "dm") query = query.eq("chat_id", currentChat.id);
    const { data } = await query;
    data.forEach(renderMessage);
  }

  function renderMessage(msg) {
    const div = document.createElement("div");
    div.classList.add("msg");
    div.classList.add(msg.sender_id === currentUser.id ? "mine" : "theirs");
    div.textContent = msg.content;
    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  }

  function subscribeToMessages() {
    client.channel("public:messages")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => {
        if (currentChat.type === "global" && !payload.new.chat_id) renderMessage(payload.new);
        if (currentChat.type === "dm" && payload.new.chat_id === currentChat.id) renderMessage(payload.new);
      })
      .subscribe();
  }

  document.getElementById("message").addEventListener("keydown", async (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const content = e.target.value.trim();
      if (!content) return;
      const { error } = await client.from("messages").insert({
        sender_id: currentUser.id,
        content,
        chat_id: currentChat.type === "dm" ? currentChat.id : null
      });
      if (!error) e.target.value = "";
    }
  });

  async function loadFriends() {
    document.getElementById("friendsList").innerHTML = "";
    const { data } = await client.from("friends").select("*").or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
    data.forEach(f => {
      const div = document.createElement("div");
      div.classList.add("friend");
      const friendId = f.user1 === currentUser.id ? f.user2 : f.user1;
      div.textContent = "Friend: " + friendId;
      div.onclick = () => {
        currentChat = { type: "dm", id: f.chat_id };
        document.getElementById("chatTitle").textContent = "Private Chat";
        loadMessages();
      };
      document.getElementById("friendsList").appendChild(div);

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const client = supabase.createClient(
      "https://fhokwoazuhkwrkrweddd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc"
    );

    const $ = id => document.getElementById(id);
    const isMobile = () => matchMedia("(max-width: 900px)").matches || 'ontouchstart' in window;
    const initials = name => (name||"?").slice(0,2).toUpperCase();
    const escapeHtml = s => s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));

    let session = null, me = { email:null, username:null }, currentView = { type:"global", peerEmail:null };

    // Startup
    (async function boot() {
      const { data:{ session: s } } = await client.auth.getSession();
      session = s;
      if(!session) show("auth"); else afterLogin(session.user);
    })();
    client.auth.onAuthStateChange((event, sess)=>{
      if(event==="SIGNED_OUT"){ me={}; show("auth"); }
      if(sess) session=sess;
    });
  }

  // Add friend popup toggle
  document.getElementById("addFriendBtn").onclick = () => {
    document.getElementById("addFriendPopup").classList.toggle("hidden");
  };
  document.getElementById("closeAddFriend").onclick = () => {
    document.getElementById("addFriendPopup").classList.add("hidden");
  };

  // Requests popup toggle
  document.getElementById("showRequestsBtn").onclick = () => {
    document.getElementById("requestsPopup").classList.toggle("hidden");
  };
  document.getElementById("closeRequests").onclick = () => {
    document.getElementById("requestsPopup").classList.add("hidden");
  };

  init();
</script>

    // Section toggle
    function show(which){
      $("auth").style.display = which==="auth"?"flex":"none";
      $("usernameSetup").style.display = which==="username"?"flex":"none";
      $("app").style.display = which==="app"?"grid":"none";
    }

    // Login
    $("loginBtn").onclick = async ()=>{
      const email=$("loginEmail").value.trim(), pass=$("loginPassword").value.trim();
      const { data, error } = await client.auth.signInWithPassword({ email, password:pass });
      if(error) return alert(error.message);
      afterLogin(data.user);
    };

    async function afterLogin(user){
      me.email=user.email;
      const { data: row } = await client.from("users").select("username").eq("email", me.email).maybeSingle();
      if(!row || !row.username) show("username"); else { me.username=row.username; initApp(); }
    }

    // Save username
    $("saveUsernameBtn").onclick = async ()=>{
      const u=$("usernameInput").value.trim();
      if(!/^[a-zA-Z0-9_]{1,15}$/.test(u)) return alert("Invalid username");
      const { data: exists } = await client.from("users").select("username").eq("username", u).maybeSingle();
      if(exists) return alert("Username taken");
      const { error } = await client.from("users").upsert({ email:me.email, username:u }, { onConflict:"email" });
      if(error) return alert(error.message);
      me.username=u; initApp();
    };

    // Init app
    function initApp(){
      $("meInfo").textContent = me.username;
      show("app");
      setRoomHeader("Global Chat","GC");
      loadFriends(); loadRequests(); loadGlobalMessages(); subscribeGlobal();
      $("composerInput").addEventListener("keydown", e=>{ if(e.key==="Enter"&&!isMobile()){ e.preventDefault(); sendMessage(); } });
      $("sendBtn").onclick = sendMessage;
      $("searchBox").addEventListener("input", debounce(searchUsers, 300));
      $("toggleSearch").onclick = ()=> $("searchSection").classList.toggle("hidden");
      $("toggleRequests").onclick = ()=> $("requestsSection").classList.toggle("hidden");
    }

    function setRoomHeader(title, initialsTxt){ $("roomTitle").textContent=title; $("roomAvatar").textContent=initialsTxt; }

    async function sendMessage(){
      const txt=$("composerInput").value.trim(); if(!txt) return;
      if(currentView.type==="global"){
        const { error } = await client.from("messages").insert({ username:me.username, message:txt, sender_email:me.email });
        if(!error) $("composerInput").value="";
      } else {
        const { error } = await client.from("dm_messages").insert({ sender_email:me.email, receiver_email:currentView.peerEmail, content:txt });
        if(!error) $("composerInput").value="";
      }
    }

    async function loadGlobalMessages(){
      const { data } = await client.from("messages").select("*").order("created_at",{ascending:true});
      const box=$("messages"); box.innerHTML="";
      (data||[]).forEach(m=>appendBubble(box,m.username,m.sender_email===me.email,m.message));
    }
    function subscribeGlobal(){
      client.channel("global-feed").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},payload=>{
        if(currentView.type==="global") appendBubble($("messages"),payload.new.username,payload.new.sender_email===me.email,payload.new.message);
      }).subscribe();
    }

    async function openDM(peerEmail, peerUsername){
      if(currentView.type==="dm"&&currentView.peerEmail===peerEmail){ currentView={type:"global"}; setRoomHeader("Global Chat","GC"); $("messages").innerHTML=""; return loadGlobalMessages(); }
      currentView={type:"dm",peerEmail}; setRoomHeader(peerUsername,initials(peerUsername));
      const { data } = await client.from("dm_messages").select("*").or(`and(sender_email.eq.${me.email},receiver_email.eq.${peerEmail}),and(sender_email.eq.${peerEmail},receiver_email.eq.${me.email})`).order("created_at",{ascending:true});
      const box=$("messages"); box.innerHTML="";
      (data||[]).forEach(m=>appendBubble(box,m.sender_email===me.email?me.username:peerUsername,m.sender_email===me.email,m.content));
      subscribeDM(peerEmail,peerUsername);
    }
    let dmChannel=null;
    function subscribeDM(peerEmail, peerUsername){
      if(dmChannel) client.removeChannel(dmChannel);
      dmChannel=client.channel(`dm-${me.email}-${peerEmail}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"dm_messages"},payload=>{
        const m=payload.new, involved=(m.sender_email===me.email&&m.receiver_email===peerEmail)||(m.sender_email===peerEmail&&m.receiver_email===me.email);
        if(currentView.type==="dm"&&involved) appendBubble($("messages"),m.sender_email===me.email?me.username:peerUsername,m.sender_email===me.email,m.content);
      }).subscribe();
    }

    async function searchUsers(){
      const q=$("searchBox").value.trim(), box=$("searchResults"); if(!q){ box.innerHTML=""; return; }
      const { data } = await client.from("users").select("email,username").ilike("username",`%${q}%`).limit(20);
      box.innerHTML=""; (data||[]).filter(u=>u.email!==me.email).forEach(u=>{
        const item=document.createElement("div"); item.className="list-item";
        item.innerHTML=`<div class="avatar">${initials(u.username)}</div><div class="meta"><div class="name">${u.username}</div><div class="muted">${u.email}</div></div><div style="margin-left:auto"><button class="btn primary">Add</button></div>`;
        item.querySelector("button").onclick=()=>sendFriendReq(u.email);
        box.appendChild(item);
      });
    }
    async function sendFriendReq(toEmail){
      await client.from("friend_requests").insert({ from_email:me.email,to_email:toEmail });
      alert("Friend request sent!");
    }

    async function loadFriends(){
      const { data } = await client.from("friends").select("friend_email,friend_username").eq("user_email",me.email);
      const box=$("friends"); box.innerHTML=""; (data||[]).forEach(f=>{
        const item=document.createElement("div"); item.className="list-item";
        item.innerHTML=`<div class="avatar">${initials(f.friend_username)}</div><div class="meta"><div class="name">${f.friend_username}</div></div>`;
        item.onclick=()=>openDM(f.friend_email,f.friend_username);
        box.appendChild(item);
      });
    }

    async function loadRequests(){
      const { data } = await client.from("friend_requests").select("id,from_email,from_user:from_email(username)").eq("to_email",me.email);
      const box=$("requests"); box.innerHTML=""; if(data&&data.length){ $("reqBadge").classList.remove("hidden"); $("reqBadge").textContent=data.length; } else $("reqBadge").classList.add("hidden");
      (data||[]).forEach(r=>{
        const item=document.createElement("div"); item.className="list-item";
        item.innerHTML=`<div class="avatar">${initials(r.from_user.username)}</div><div class="meta"><div class="name">${r.from_user.username}</div></div><div style="margin-left:auto"><button class="btn success">✓</button><button class="btn danger">✕</button></div>`;
        const [btnA,btnD]=item.querySelectorAll("button");
        btnA.onclick=()=>acceptReq(r.id,r.from_email,r.from_user.username);
        btnD.onclick=()=>declineReq(r.id);
        box.appendChild(item);
      });
    }
    async function acceptReq(id, fromEmail, fromUsername){
      await client.from("friends").insert([{user_email:me.email,friend_email:fromEmail,friend_username:fromUsername},{user_email:fromEmail,friend_email:me.email,friend_username:me.username}]);
      await client.from("friend_requests").delete().eq("id",id);
      loadFriends(); loadRequests();
    }
    async function declineReq(id){ await client.from("friend_requests").delete().eq("id",id); loadRequests(); }

    function appendBubble(box,username,isMe,text){
      const b=document.createElement("div"); b.className=`bubble ${isMe?"me":"them"}`;
      b.innerHTML=isMe?`${escapeHtml(text)}`:`<div class="from"><div class="avatar">${initials(username)}</div>${username}</div>${escapeHtml(text)}`;
      box.appendChild(b); box.scrollTop=box.scrollHeight;
    }
    function debounce(fn,delay){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); }; }
  </script>
</body>
</html>
